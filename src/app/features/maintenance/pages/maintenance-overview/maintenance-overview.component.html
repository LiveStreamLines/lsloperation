<section class="space-y-8">
  <header class="rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Operations control</p>
        <h1 class="mt-2 text-3xl font-bold text-slate-900">Maintenance coordination</h1>
        <p class="mt-2 max-w-2xl text-sm text-slate-500">
          Track corrective work, unlock preventive routines, and keep every camera operational. Filters follow the legacy
          workflow so you can pivot by developer, project, camera, or assigned engineer.
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
          (click)="refresh()"
          [disabled]="isRefreshing() || isLoading()"
        >
          <svg viewBox="0 0 20 20" class="h-4 w-4 fill-current">
            <path
              d="M3.172 7A7.001 7.001 0 0117 10a1 1 0 11-2 0 5 5 0 00-8.9-3H8a1 1 0 010 2H3a1 1 0 01-1-1V3a1 1 0 012 0v2a6.964 6.964 0 011.172 2zM17 13l.001 4a1 1 0 01-1 1H12a1 1 0 010-2h2.899A5.002 5.002 0 007 11a1 1 0 010-2 7 7 0 018.828 5H12a1 1 0 110-2h5a1 1 0 011 1z"
            />
          </svg>
          {{ isRefreshing() ? 'Refreshing…' : 'Refresh data' }}
        </button>
      </div>
    </div>
  </header>

  @if (toast()) {
    <div class="fixed right-6 top-6 z-50">
      <div
        class="flex items-center gap-3 rounded-2xl px-4 py-3 shadow-lg"
        [ngClass]="toast()!.tone === 'success' ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'"
      >
        <span class="text-sm font-semibold">{{ toast()!.message }}</span>
        <button
          type="button"
          class="rounded-full p-1 text-xs font-semibold uppercase tracking-wide text-slate-400 transition hover:text-slate-600"
          (click)="dismissToast()"
        >
          Close
        </button>
      </div>
    </div>
  }

  @if (errorMessage()) {
    <div class="rounded-3xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 shadow-sm">
      {{ errorMessage() }}
    </div>
  }

  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-5">
    @for (card of metricCards(); track card.title) {
      <article
        class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm transition hover:border-slate-300 hover:shadow-md"
      >
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{ card.title }}</p>
        <p class="mt-3 text-2xl font-semibold text-slate-900">{{ card.value }}</p>
        <p
          class="mt-2 text-xs font-medium uppercase tracking-wide"
          [ngClass]="
            card.tone === 'positive'
              ? 'text-emerald-600'
              : card.tone === 'warning'
                ? 'text-amber-600'
                : 'text-slate-500'
          "
        >
          {{ card.helper }}
        </p>
      </article>
    }
  </div>

  <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-col gap-4 border-b border-slate-100 pb-5">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap gap-2">
          @for (option of statusOptions(); track option.value) {
            <button
              type="button"
              class="inline-flex items-center rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide transition"
              [ngClass]="
                (option.value === 'all' && !selectedStatus()) ||
                (option.value !== 'all' && selectedStatus() === option.value)
                  ? 'border-indigo-500 bg-indigo-600 text-white shadow-lg shadow-indigo-300'
                  : 'border-slate-200 bg-white text-slate-600 hover:bg-slate-50'
              "
              (click)="onStatusChange(option.value)"
            >
              {{ option.label }}
            </button>
          }
        </div>
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
          {{ filteredTasks().length }} task{{ filteredTasks().length === 1 ? '' : 's' }} in view
        </span>
      </div>
    </div>

    <div class="mt-6 grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <label class="flex flex-col gap-2 text-sm text-slate-600">
        <span class="font-semibold text-slate-800">Developer</span>
        <select
          class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          [value]="selectedDeveloperId() ?? ''"
          (change)="onDeveloperChange($any($event.target).value)"
        >
          <option value="">All developers</option>
          @for (option of developerOptions(); track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>

      <label class="flex flex-col gap-2 text-sm text-slate-600">
        <span class="font-semibold text-slate-800">Project</span>
        <select
          class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
          [value]="selectedProjectId() ?? ''"
          [disabled]="!selectedDeveloperId()"
          (change)="onProjectChange($any($event.target).value)"
        >
          <option value="">All projects</option>
          @for (option of projectOptions(); track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>

      <label class="flex flex-col gap-2 text-sm text-slate-600">
        <span class="font-semibold text-slate-800">Camera</span>
        <select
          class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
          [value]="selectedCameraId() ?? ''"
          [disabled]="!selectedProjectId()"
          (change)="onCameraChange($any($event.target).value)"
        >
          <option value="">All cameras</option>
          @for (option of cameraOptions(); track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>

      <label class="flex flex-col gap-2 text-sm text-slate-600">
        <span class="font-semibold text-slate-800">Task type</span>
        <select
          class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          [value]="selectedTaskType() ?? ''"
          (change)="onTaskTypeChange($any($event.target).value)"
        >
          <option value="">All task types</option>
          @for (option of taskTypeOptions(); track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>

      @if (isSuperAdmin()) {
        <label class="flex flex-col gap-2 text-sm text-slate-600 md:col-span-2 xl:col-span-1">
          <span class="font-semibold text-slate-800">Assigned engineer</span>
          <select
            class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            [value]="selectedUserId() ?? ''"
            (change)="onAssignedUserChange($any($event.target).value)"
          >
            <option value="">All engineers</option>
            @for (option of assignedUserOptions(); track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </label>
      } @else {
        <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500 md:col-span-2 xl:col-span-1">
          <span class="font-semibold text-slate-700">Viewing tasks for:</span>
          <span class="ml-1">{{ currentUserName() }}</span>
        </div>
      }
    </div>

    <div class="mt-6 flex flex-wrap items-center justify-between gap-3">
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900"
        (click)="clearFilters()"
      >
        <svg viewBox="0 0 20 20" class="h-4 w-4 fill-current">
          <path
            d="M12.146 7.854a.5.5 0 0 1 0-.708L14.293 5H6.5a.5.5 0 010-1h7.793l-2.147-2.146a.5.5 0 11.708-.708l3 3a.5.5 0 010 .708l-3 3a.5.5 0 01-.708 0zM7.854 12.146a.5.5 0 010 .708L5.707 15H13.5a.5.5 0 010 1H5.707l2.147 2.146a.5.5 0 01-.708.708l-3-3a.5.5 0 010-.708l3-3a.5.5 0 01.708 0z"
          />
        </svg>
        Reset filters
      </button>
      <span class="text-xs text-slate-400">
        Showing {{ filteredTasks().length }} of {{ tasks().length }} records
      </span>
    </div>
  </div>

  @if (isLoading()) {
    <div class="rounded-3xl border border-slate-200 bg-white p-10 text-center text-sm text-slate-500 shadow-sm">
      Loading maintenance requests…
    </div>
  } @else {
    @if (filteredTasks().length === 0) {
      <div class="rounded-3xl border border-dashed border-slate-200 bg-white p-16 text-center shadow-sm">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-slate-100 text-slate-400">
          <svg viewBox="0 0 24 24" class="h-6 w-6 fill-current">
            <path
              d="M5.636 5.636a9 9 0 1112.728 12.728A9 9 0 015.636 5.636zm10.607 2.121A7 7 0 006.343 17.657 7 7 0 0016.243 7.757zM11 7a1 1 0 011 1v3.586l1.707 1.707a1 1 0 11-1.414 1.414l-2-2A1 1 0 0110 11V8a1 1 0 011-1z"
            />
          </svg>
        </div>
        <h3 class="mt-6 text-lg font-semibold text-slate-900">No maintenance requests match these filters</h3>
        <p class="mt-2 text-sm text-slate-500">Adjust the criteria to see additional work orders.</p>
      </div>
    } @else {
      <div class="grid gap-4">
        @for (task of filteredTasks(); track task.id) {
          <article
            class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm transition hover:border-indigo-200 hover:shadow-lg"
          >
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div class="space-y-2">
                <div class="flex items-center gap-3 text-xs font-semibold uppercase tracking-wide text-slate-400">
                  <span>{{ task.id }}</span>
                  @if (task.isOverdue && task.status !== 'completed') {
                    <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide text-amber-700">
                      <svg viewBox="0 0 20 20" class="h-3 w-3 fill-current">
                        <path
                          d="M8.257 3.099c.765-1.36 2.721-1.36 3.486 0l6.518 11.6A1.75 1.75 0 0116.768 17H3.232a1.75 1.75 0 01-1.493-2.301l6.518-11.6zM10 13a1 1 0 100 2 1 1 0 000-2zm-.75-5.75a.75.75 0 011.5 0v3.5a.75.75 0 01-1.5 0v-3.5z"
                        />
                      </svg>
                      Overdue
                    </span>
                  }
                </div>
                <h2 class="text-xl font-semibold text-slate-900">{{ task.taskType }}</h2>
                <p class="text-sm text-slate-500">
                  {{ task.taskDescription || 'No description provided.' }}
                </p>
                <div class="mt-3 flex flex-wrap gap-3 text-xs text-slate-500">
                  <span class="inline-flex items-center gap-2">
                    <span class="font-semibold text-slate-700">Developer</span>
                    <span>{{ task.developerName }}</span>
                  </span>
                  <span class="inline-flex items-center gap-2">
                    <span class="font-semibold text-slate-700">Project</span>
                    <span>{{ task.projectName }}</span>
                  </span>
                  <span class="inline-flex items-center gap-2">
                    <span class="font-semibold text-slate-700">Camera</span>
                    <span>{{ task.cameraName }}</span>
                  </span>
                </div>
              </div>
              <div class="flex flex-col items-end gap-2 text-sm">
                <span
                  class="inline-flex items-center rounded-full px-3 py-1 text-[11px] font-semibold uppercase tracking-wide"
                  [ngClass]="
                    task.status === 'completed'
                      ? 'bg-emerald-50 text-emerald-700'
                      : task.status === 'in-progress'
                        ? 'bg-blue-50 text-blue-700'
                        : task.status === 'cancelled'
                          ? 'bg-slate-200 text-slate-500'
                          : 'bg-amber-50 text-amber-700'
                  "
                >
                  {{ task.status | titlecase }}
                </span>
                <div class="flex flex-wrap justify-end gap-2">
                  <button
                    type="button"
                    class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-600 transition hover:border-indigo-300 hover:bg-indigo-50 disabled:cursor-not-allowed disabled:opacity-60"
                    (click)="startTask(task)"
                    [disabled]="task.status !== 'pending'"
                  >
                    <svg viewBox="0 0 20 20" class="h-3.5 w-3.5 fill-current">
                      <path d="M6 4.5a.5.5 0 01.757-.429l8 4.5a.5.5 0 010 .858l-8 4.5A.5.5 0 016 13.5v-9z" />
                    </svg>
                    Start
                  </button>
                  <button
                    type="button"
                    class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-600 transition hover:border-emerald-300 hover:bg-emerald-50 disabled:cursor-not-allowed disabled:opacity-60"
                    (click)="openCompleteTaskModal(task)"
                    [disabled]="task.status !== 'in-progress'"
                  >
                    <svg viewBox="0 0 20 20" class="h-3.5 w-3.5 fill-current">
                      <path
                        d="M16.707 5.293a1 1 0 010 1.414l-7.25 7.25a1 1 0 01-1.414 0l-3.25-3.25a1 1 0 111.414-1.414L8.5 11.586l6.543-6.543a1 1 0 011.414 0z"
                      />
                    </svg>
                    Complete
                  </button>
                  @if (isSuperAdmin()) {
                    <button
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-slate-300 hover:bg-slate-50"
                      (click)="openEditTaskModal(task)"
                    >
                      <svg viewBox="0 0 20 20" class="h-3.5 w-3.5 fill-current">
                        <path
                          d="M13.586 3a2 2 0 012.828 2.828l-9.192 9.19a1 1 0 01-.45.263l-3 1a1 1 0 01-1.263-1.263l1-3a1 1 0 01.263-.45l9.191-9.192zM12.172 5L5 12.172V15h2.828L15 7.828 12.172 5z"
                        />
                      </svg>
                      Edit
                    </button>
                    @if (task.cameraId) {
                      <button
                        type="button"
                        class="inline-flex items-center gap-2 rounded-full border border-amber-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-amber-600 transition hover:border-amber-300 hover:bg-amber-50 disabled:cursor-not-allowed disabled:opacity-60"
                        (click)="openInstallMaterialsModal(task)"
                        [disabled]="completeTaskForm().isSaving"
                      >
                        <svg viewBox="0 0 20 20" class="h-3.5 w-3.5 fill-current">
                          <path
                            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                          />
                        </svg>
                        Install materials
                      </button>
                    }
                  }
                </div>
              </div>
            </div>

            <div class="mt-6 grid gap-4 border-t border-slate-100 pt-4 text-xs text-slate-500 md:grid-cols-2 lg:grid-cols-4">
              <div class="space-y-1">
                <p class="font-semibold text-slate-700">Requested</p>
                <p>{{ task.dateOfRequest ? (task.dateOfRequest | date: 'medium') : '—' }}</p>
              </div>
              <div class="space-y-1">
                <p class="font-semibold text-slate-700">Started</p>
                <p>{{ task.startTime ? (task.startTime | date: 'medium') : '—' }}</p>
              </div>
              <div class="space-y-1">
                <p class="font-semibold text-slate-700">Completed</p>
                <p>{{ task.completionTime ? (task.completionTime | date: 'medium') : '—' }}</p>
                @if (task.durationMinutes) {
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">
                    Duration {{ task.durationMinutes }} min
                  </p>
                }
              </div>
              <div class="space-y-1">
                <p class="font-semibold text-slate-700">Assigned engineers</p>
                <div class="flex flex-wrap gap-2">
                  @if (task.assignedUsers.length === 0) {
                    <span class="text-slate-400">Unassigned</span>
                  } @else {
                    @for (user of task.assignedUsers; track user.id) {
                      <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                        {{ user.name }}
                      </span>
                    }
                  }
                </div>
              </div>
              @if (task.userComment) {
                <div class="md:col-span-2 lg:col-span-4">
                  <p class="font-semibold text-slate-700">Technician comment</p>
                  <p class="mt-1 text-sm text-slate-600">{{ task.userComment }}</p>
                </div>
              }
            </div>
          </article>
        }
      </div>
    }
  }

  @if (editTaskModal()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/60 backdrop-blur-sm">
      <div class="relative w-full max-w-3xl rounded-3xl bg-white p-8 shadow-2xl">
        <button
          type="button"
          class="absolute right-4 top-4 rounded-full border border-slate-200 bg-white p-2 text-slate-500 transition hover:text-slate-900"
          (click)="closeEditTaskModal()"
          [disabled]="editTaskForm().isSaving"
        >
          <span class="sr-only">Close modal</span>
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path
              d="M6.28 5.22a.75.75 0 10-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 10-1.06-1.06L10 8.94 6.28 5.22z"
            />
          </svg>
        </button>

        <div class="space-y-6">
          <header>
            <h2 class="text-xl font-semibold text-slate-900">Edit maintenance task</h2>
            <p class="mt-1 text-sm text-slate-500">
              Adjust task details, team assignment, or status. Status changes follow the legacy rules (pending clears the timeline).
            </p>
          </header>

          @if (editTaskForm().error) {
            <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
              {{ editTaskForm().error }}
            </div>
          }

          <div class="grid gap-4 md:grid-cols-2">
            <label class="flex flex-col gap-2 text-sm text-slate-600 md:col-span-2">
              <span class="font-semibold text-slate-800">Task type</span>
              <input
                type="text"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                [value]="editTaskForm().taskType"
                (input)="onEditTaskFieldChange('taskType', $any($event.target).value)"
              />
            </label>

            <label class="flex flex-col gap-2 text-sm text-slate-600 md:col-span-2">
              <span class="font-semibold text-slate-800">Task description</span>
              <textarea
                rows="4"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                [value]="editTaskForm().taskDescription"
                (input)="onEditTaskFieldChange('taskDescription', $any($event.target).value)"
              ></textarea>
            </label>

            <div class="flex flex-col gap-2 text-sm text-slate-600 md:col-span-2">
              <span class="font-semibold text-slate-800">Assigned engineers</span>
              <div class="relative multi-select-dropdown">
                <button
                  type="button"
                  class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-left text-sm shadow-sm transition hover:border-slate-300 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  (click)="toggleEditAssignedUsersDropdown()"
                >
                  <span class="text-slate-600">
                    @if (editTaskForm().assignedUsers.length === 0) {
                      Select engineers...
                    } @else {
                      {{ editTaskForm().assignedUsers.length }} selected
                    }
                  </span>
                  <svg
                    class="h-5 w-5 text-slate-400 transition-transform"
                    [class.rotate-180]="isEditAssignedUsersDropdownOpen()"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                @if (isEditAssignedUsersDropdownOpen()) {
                  <div
                    class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-2xl border border-slate-200 bg-white shadow-lg ring-1 ring-black ring-opacity-5"
                  >
                    <div class="p-2">
                      @for (option of assignedUserOptions(); track option.value) {
                        <label
                          class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-slate-50"
                          (click)="toggleEditAssignedUserSelection(option.value)"
                        >
                          <input
                            type="checkbox"
                            class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                            [checked]="isEditAssignedUserSelected(option.value)"
                            (change)="$event.stopPropagation()"
                          />
                          <span class="text-slate-700">{{ option.label }}</span>
                        </label>
                      }
                    </div>
                  </div>
                }
              </div>
              @if (editTaskForm().assignedUsers.length > 0) {
                <div class="flex flex-wrap gap-2">
                  @for (userId of editTaskForm().assignedUsers; track userId) {
                    <span
                      class="inline-flex items-center gap-1.5 rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700"
                    >
                      {{ getAssignedUserLabel(userId) }}
                      <button
                        type="button"
                        class="rounded-full hover:bg-indigo-200"
                        (click)="removeEditAssignedUser(userId)"
                      >
                        <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                          <path
                            fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </button>
                    </span>
                  }
                </div>
              }
            </div>

            <label class="flex flex-col gap-2 text-sm text-slate-600 md:col-span-2">
              <span class="font-semibold text-slate-800">Status</span>
              <select
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                [value]="editTaskForm().status"
                (change)="setEditTaskStatus($any($event.target).value)"
              >
                @for (option of statusOptions(); track option.value) {
                  @if (option.value !== 'all') {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                }
              </select>
            </label>
          </div>

          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
              (click)="closeEditTaskModal()"
              [disabled]="editTaskForm().isSaving"
            >
              Cancel
            </button>
            <button
              type="button"
              class="inline-flex items-center rounded-2xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-300 transition hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
              (click)="saveEditTask()"
              [disabled]="editTaskForm().isSaving"
            >
              <span>{{ editTaskForm().isSaving ? 'Saving…' : 'Save changes' }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (completeTaskModal()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/60 backdrop-blur-sm">
      <div class="relative w-full max-w-xl rounded-3xl bg-white shadow-2xl">
        <button
          type="button"
          class="absolute right-4 top-4 rounded-full border border-slate-200 bg-white p-2 text-slate-500 transition hover:text-slate-900"
          (click)="closeCompleteTaskModal()"
          [disabled]="completeTaskForm().isSaving"
        >
          <span class="sr-only">Close modal</span>
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path
              d="M6.28 5.22a.75.75 0 10-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 10-1.06-1.06L10 8.94 6.28 5.22z"
            />
          </svg>
        </button>

        <div class="max-h-[80vh] overflow-y-auto p-8">
          <div class="space-y-6">
          <header>
            <h2 class="text-xl font-semibold text-slate-900">Complete task</h2>
            <p class="mt-1 text-sm text-slate-500">
              Add a short completion note (minimum {{ completionCommentMin }} characters). This mirrors the legacy completion dialog.
            </p>
          </header>

          @if (completeTaskForm().error) {
            <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
              {{ completeTaskForm().error }}
            </div>
          }

          <section class="space-y-4 rounded-3xl border border-slate-200 bg-slate-50 p-4">
            <div>
              <h3 class="text-sm font-semibold text-slate-900">Completion checklist</h3>
              <p class="mt-1 text-xs text-slate-500">
                Select every action performed while closing this task.
              </p>
            </div>

            <ng-template #materialReplacementBlock let-required="required" let-title="title" let-key="key">
              <div class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-4 text-sm">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <h4 class="text-sm font-semibold text-slate-900">
                      {{ title }}
                    </h4>
                    <p class="mt-1 text-xs text-slate-500">
                      Select the components swapped on {{ completeTaskModal()?.cameraName || 'this camera' }} and log the reason.
                    </p>
                  </div>
                  <span
                    class="inline-flex items-center rounded-full bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide"
                    [ngClass]="required ? 'text-rose-600' : 'text-slate-500'"
                  >
                    {{ required ? 'Required' : 'Optional' }}
                  </span>
                </div>

                @if (completeMaterialsState().error) {
                  <div class="mt-3 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                    {{ completeMaterialsState().error }}
                  </div>
                }

                @if (completeMaterialsState().isLoading) {
                  <div class="mt-3 flex items-center justify-center rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-500">
                    Loading assigned materials…
                  </div>
                } @else {
                  @if (completeMaterialsState().entries.length === 0) {
                    <div class="mt-3 rounded-2xl border border-dashed border-slate-300 bg-white px-4 py-3 text-sm text-slate-500">
                      No inventory items are currently linked to this camera.
                    </div>
                  } @else {
                    @if (!hasAvailableMaterialEntries(key)) {
                      <div class="mt-3 rounded-2xl border border-dashed border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                        No materials currently assigned to you match this action.
                      </div>
                    }
                    <div class="mt-3 space-y-3">
                      @for (entry of completeMaterialsState().entries; track entry.item._id) {
                        @if (entryVisibleInContext(entry, key)) {
                          <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                          <div class="flex items-start gap-3">
                            <input
                              type="checkbox"
                              class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                                [checked]="entry.context === key && entry.selected"
                                (change)="toggleCompleteMaterialEntry(entry.item._id, $any($event.target).checked, key)"
                            />
                            <div class="flex-1 space-y-2">
                              <p class="text-sm font-semibold text-slate-800">
                                {{ inventoryShortLabel(entry.item) }}
                              </p>
                              <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                                <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1">
                                  Type: {{ inventoryDeviceType(entry.item) }}
                                </span>
                                @if (inventoryDeviceModel(entry.item)) {
                                  <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1">
                                    Model: {{ inventoryDeviceModel(entry.item) }}
                                  </span>
                                }
                                <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1">
                                  Serial: {{ inventoryDeviceSerial(entry.item) }}
                                </span>
                              </div>

                              @if (entry.selected) {
                                <label class="mt-2 flex flex-col gap-2 text-xs text-slate-600">
                                  <span class="font-semibold text-slate-700">Replacement inventory</span>
                                  <select
                                    class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    [value]="entry.replacementId ?? ''"
                                      (change)="setCompleteReplacementSelection(entry.item._id, $any($event.target).value, key)"
                                  >
                                    <option value="">Remove only (no replacement)</option>
                                    @for (candidate of availableCompleteReplacementOptions(entry); track candidate._id) {
                                      <option [value]="candidate._id">{{ inventoryShortLabel(candidate) }}</option>
                                    }
                                  </select>
                                  @if (availableCompleteReplacementOptions(entry).length === 0) {
                                    <span class="text-[11px] text-amber-600">
                                      No materials of this type are currently assigned to you.
                                    </span>
                                  }
                                </label>
                              }
                            </div>
                          </div>
                          </div>
                        }
                      }
                    </div>

                    <label class="mt-3 flex flex-col gap-2 text-sm text-slate-600">
                      <span class="font-semibold text-slate-800">
                        Reason for replacement
                      </span>
                      <textarea
                        rows="3"
                        class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        [value]="completeMaterialsState().reason"
                        (input)="setCompleteReplaceReason($any($event.target).value)"
                        placeholder="E.g., Faulty modem, upgrade to new model, damaged cabling."
                      ></textarea>
                      <span class="text-[11px] text-slate-400">
                        {{ required ? 'Required for breakdown resolution.' : 'Required when selecting at least one material to swap.' }}
                      </span>
                    </label>
                  }
                }
              </div>
            </ng-template>

            <div class="space-y-3">
              <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <label class="flex items-start gap-3 text-sm">
                  <input
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                    [checked]="completeTaskForm().actions.breakdown"
                    [disabled]="shouldDisableStandardActions() && !completeTaskForm().actions.breakdown"
                    (change)="toggleCompletionAction('breakdown', $any($event.target).checked)"
                  />
                  <div class="flex-1">
                    <p class="font-semibold text-slate-900">Breakdown</p>
                    <p class="text-xs text-slate-500">
                      Fault isolation with immediate material replacement.
                    </p>
                  </div>
                </label>

                @if (completeTaskForm().actions.breakdown) {
                  <div class="flex items-center justify-between rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
                    <label class="inline-flex items-center gap-3 font-semibold uppercase tracking-wide text-slate-600">
                      <input
                        type="checkbox"
                        class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                        [disabled]="shouldDisableStandardActions()"
                        [checked]="completeTaskForm().actions.breakdownNone"
                        (change)="toggleBreakdownNone($any($event.target).checked)"
                      />
                      None (no replacement required)
                    </label>
                  </div>

                  @if (!completeTaskForm().actions.breakdownNone) {
                  <ng-container
                    *ngTemplateOutlet="materialReplacementBlock; context: { required: true, title: 'Breakdown material replacement', key: 'breakdown' }"
                  ></ng-container>
                  } @else {
                    <label class="flex flex-col gap-2 text-sm text-slate-600">
                      <span class="font-semibold text-slate-800">Breakdown reason</span>
                      <textarea
                        rows="3"
                        class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        [value]="completeTaskForm().breakdownReason"
                        (input)="onBreakdownReasonChange($any($event.target).value)"
                        placeholder="Explain the incident and corrective steps."
                      ></textarea>
                      <span class="text-[11px] text-slate-400">Required (minimum 5 characters).</span>
                    </label>
                  }
                }
              </div>

              <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <label class="flex items-start gap-3 text-sm">
                  <input
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                    [checked]="completeTaskForm().actions.maintenance.enabled"
                    [disabled]="shouldDisableStandardActions() && !completeTaskForm().actions.maintenance.enabled"
                    (change)="toggleCompletionAction('maintenance', $any($event.target).checked)"
                  />
                  <div class="flex-1">
                    <p class="font-semibold text-slate-900">Maintenance</p>
                    <p class="text-xs text-slate-500">
                      Preventive work such as cleaning, view adjustment, or targeted swaps.
                    </p>
                  </div>
                </label>

                @if (completeTaskForm().actions.maintenance.enabled) {
                  <div class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-xs text-slate-600">
                    <p class="font-semibold text-slate-900">Maintenance details</p>
                    <div class="mt-3 flex flex-col gap-2">
                      <label class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-semibold uppercase tracking-wide text-slate-600">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                          [checked]="completeTaskForm().actions.maintenance.cleaning"
                          (change)="toggleMaintenanceOption('cleaning', $any($event.target).checked)"
                        />
                        Cleaning
                      </label>
                      <label class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-semibold uppercase tracking-wide text-slate-600">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                          [checked]="completeTaskForm().actions.maintenance.viewAdjustment"
                          (change)="toggleMaintenanceOption('viewAdjustment', $any($event.target).checked)"
                        />
                        View adjustment
                      </label>
                      <label class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-semibold uppercase tracking-wide text-slate-600">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                          [checked]="completeTaskForm().actions.maintenance.materialReplacement"
                          (change)="toggleMaintenanceOption('materialReplacement', $any($event.target).checked)"
                        />
                        Material replacement
                      </label>
                      <label class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-semibold uppercase tracking-wide text-slate-600">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                          [checked]="completeTaskForm().actions.maintenance.lockChecked"
                          (change)="toggleMaintenanceOption('lockChecked', $any($event.target).checked)"
                        />
                        Lock Checked
                      </label>
                      <label class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-semibold uppercase tracking-wide text-slate-600">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                          [checked]="completeTaskForm().actions.maintenance.memoryChanging"
                          (change)="toggleMaintenanceOption('memoryChanging', $any($event.target).checked)"
                        />
                        Memory Changing
                      </label>
                    </div>

                    @if (completeTaskForm().actions.maintenance.memoryChanging) {
                      <div class="mt-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-xs text-slate-600">
                        @if (getCurrentTaskMemory()) {
                          <div class="flex flex-wrap items-center justify-between gap-2">
                            <span class="font-semibold text-slate-800">
                              Status: {{ ((getCurrentTaskMemory()?.status) || 'active') | titlecase }}
                            </span>
                            <span class="inline-flex items-center rounded-full border border-slate-300 bg-slate-50 px-3 py-1 font-semibold uppercase tracking-wide text-slate-700">
                              Assigned memory
                            </span>
                          </div>
                          <div class="mt-2 grid gap-2 md:grid-cols-2">
                            <div>
                              <p>
                                Used:
                                <span class="font-semibold">
                                  {{ getCurrentTaskMemory()?.memoryUsed || '—' }}
                                </span>
                              </p>
                              <p>
                                Available:
                                <span class="font-semibold">
                                  {{ getCurrentTaskMemory()?.memoryAvailable || '—' }}
                                </span>
                              </p>
                            </div>
                            <div>
                              <p>
                                Pictures:
                                <span class="font-semibold">
                                  {{
                                    getCurrentTaskMemory()?.numberofpics
                                      ?? getCurrentTaskMemory()?.['numberOfPics']
                                      ?? getCurrentTaskMemory()?.['numberofpic']
                                      ?? getCurrentTaskMemory()?.['numberOfPic']
                                      ?? '—'
                                  }}
                                </span>
                              </p>
                              <p>
                                Shutter count:
                                <span class="font-semibold">
                                  {{ getCurrentTaskMemory()?.shuttercount ?? '—' }}
                                </span>
                              </p>
                            </div>
                          </div>
                          <div class="mt-2 grid gap-1 md:grid-cols-2 text-[11px] text-slate-500">
                            <p>
                              Start:
                              <span class="font-semibold">
                                {{
                                  getCurrentTaskMemory()?.createdDate
                                    ? (getCurrentTaskMemory()?.createdDate | date: 'medium')
                                    : '—'
                                }}
                              </span>
                            </p>
                            <p>
                              End:
                              <span class="font-semibold">
                                {{
                                  getCurrentTaskMemory()?.endDate
                                    ? (getCurrentTaskMemory()?.endDate | date: 'medium')
                                    : getCurrentTaskMemory()?.dateOfRemoval
                                      ? (getCurrentTaskMemory()?.dateOfRemoval | date: 'medium')
                                      : getCurrentTaskMemory()?.dateOfReceive
                                        ? (getCurrentTaskMemory()?.dateOfReceive | date: 'medium')
                                        : '—'
                                }}
                              </span>
                            </p>
                          </div>
                        } @else {
                          <p class="text-xs text-rose-600">
                            No memory record is currently assigned to this camera.
                          </p>
                        }
                      </div>
                    }
                  </div>

                  @if (completeTaskForm().actions.maintenance.materialReplacement) {
                    <ng-container
                      *ngTemplateOutlet="materialReplacementBlock; context: { required: false, title: 'Maintenance material replacement', key: 'maintenance' }"
                    ></ng-container>
                  }
                }
              </div>

              <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <label class="flex items-start gap-3 text-sm">
                  <input
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                    [checked]="completeTaskForm().actions.addItems"
                    [disabled]="shouldDisableStandardActions() && !completeTaskForm().actions.addItems"
                    (change)="toggleCompletionAction('addItems', $any($event.target).checked)"
                  />
                  <div class="flex-1">
                    <p class="font-semibold text-slate-900">Add items</p>
                    <p class="text-xs text-slate-500">
                      Deploy spare materials currently assigned to you onto this camera.
                    </p>
                  </div>
                </label>

                @if (completeTaskForm().actions.addItems) {
                  @if (completeInventoryState().error?.includes('add')) {
                    <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                      {{ completeInventoryState().error }}
                    </div>
                  }

                  @if (!hasAvailableAddItems()) {
                    <div class="rounded-2xl border border-dashed border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                      You have no spare materials assigned to you.
                    </div>
                  } @else {
                    <div class="space-y-3">
                      @for (item of availableAddItems(); track item._id) {
                        <label
                          class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm shadow-sm transition hover:border-indigo-300"
                        >
                          <input
                            type="checkbox"
                            class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                            [checked]="isAddItemSelected(item._id)"
                            (change)="toggleAddItemSelection(item._id, $any($event.target).checked)"
                          />
                          <div class="flex-1 space-y-1">
                            <p class="font-semibold text-slate-900">
                              {{ inventoryShortLabel(item) }}
                            </p>
                            <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Type: {{ item.device?.type || 'Unknown type' }}
                              </span>
                              @if (item.device?.model) {
                                <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                  Model: {{ item.device?.model }}
                                </span>
                              }
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Serial: {{ item.device?.serialNumber || item._id }}
                              </span>
                            </div>
                          </div>
                        </label>
                      }
                    </div>
                  }
                }
              </div>

              <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <label class="flex items-start gap-3 text-sm">
                  <input
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                    [checked]="completeTaskForm().actions.removeItems"
                    [disabled]="shouldDisableStandardActions() && !completeTaskForm().actions.removeItems"
                    (change)="toggleCompletionAction('removeItems', $any($event.target).checked)"
                  />
                  <div class="flex-1">
                    <p class="font-semibold text-slate-900">Remove items</p>
                    <p class="text-xs text-slate-500">
                      Collect unused materials from this camera back into your technician stock.
                    </p>
                  </div>
                </label>

                @if (completeTaskForm().actions.removeItems) {
                  @if (completeInventoryState().error?.includes('remove')) {
                    <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                      {{ completeInventoryState().error }}
                    </div>
                  }

                  @if (!hasRemovableEntries()) {
                    <div class="rounded-2xl border border-dashed border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                      All camera materials are already covered by replacement or removal steps.
                    </div>
                  } @else {
                    <div class="space-y-3">
                      @for (entry of removableEntries(); track entry.item._id) {
                        <label
                          class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm shadow-sm transition hover:border-indigo-300"
                        >
                          <input
                            type="checkbox"
                            class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                            [checked]="isRemoveItemSelected(entry.item._id)"
                            (change)="toggleRemoveItemSelection(entry.item._id, $any($event.target).checked)"
                          />
                          <div class="flex-1 space-y-1">
                            <p class="font-semibold text-slate-900">
                              {{ inventoryShortLabel(entry.item) }}
                            </p>
                            <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Type: {{ inventoryDeviceType(entry.item) }}
                              </span>
                              @if (inventoryDeviceModel(entry.item)) {
                                <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                  Model: {{ inventoryDeviceModel(entry.item) }}
                                </span>
                              }
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Serial: {{ inventoryDeviceSerial(entry.item) }}
                              </span>
                            </div>
                          </div>
                        </label>
                      }
                    </div>
                  }
                }
              </div>

              <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <label class="flex items-start gap-3 text-sm">
                  <input
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                    [checked]="completeTaskForm().actions.removal"
                    [disabled]="shouldDisableHighPriorityActions() && !completeTaskForm().actions.removal"
                    (change)="toggleCompletionAction('removal', $any($event.target).checked)"
                  />
                  <div class="flex-1">
                    <p class="font-semibold text-slate-900">Removal</p>
                    <p class="text-xs text-slate-500">
                      Unassign all camera materials and return them to technician custody.
                    </p>
                  </div>
                </label>

                @if (completeTaskForm().actions.removal) {
                  <p class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
                    All inventory on this camera will be unassigned and reassigned to you when the task is completed.
                  </p>
                }
              </div>

              <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <label class="flex items-start gap-3 text-sm">
                  <input
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                    [checked]="completeTaskForm().actions.installation"
                    [disabled]="shouldDisableHighPriorityActions() && !completeTaskForm().actions.installation"
                    (change)="toggleCompletionAction('installation', $any($event.target).checked)"
                  />
                  <div class="flex-1">
                    <p class="font-semibold text-slate-900">Installation</p>
                    <p class="text-xs text-slate-500">
                      New hardware deployed and configured on site.
                    </p>
                  </div>
                </label>

                @if (completeTaskForm().actions.installation) {
                  @if (completeInventoryState().error?.includes('add')) {
                    <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                      {{ completeInventoryState().error }}
                    </div>
                  }

                  @if (!hasAvailableAddItems()) {
                    <div class="rounded-2xl border border-dashed border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                      You have no spare materials assigned to you.
                    </div>
                  } @else {
                    <div class="space-y-3">
                      @for (item of availableAddItems(); track item._id) {
                        <label
                          class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm shadow-sm transition hover:border-indigo-300"
                        >
                          <input
                            type="checkbox"
                            class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                            [checked]="isAddItemSelected(item._id)"
                            (change)="toggleAddItemSelection(item._id, $any($event.target).checked)"
                          />
                          <div class="flex-1 space-y-1">
                            <p class="font-semibold text-slate-900">
                              {{ inventoryShortLabel(item) }}
                            </p>
                            <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Type: {{ item.device?.type || 'Unknown type' }}
                              </span>
                              @if (item.device?.model) {
                                <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                  Model: {{ item.device?.model }}
                                </span>
                              }
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Serial: {{ item.device?.serialNumber || item._id }}
                              </span>
                            </div>
                          </div>
                        </label>
                      }
                    </div>
                  }
                }
              </div>

              <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <label class="flex items-start gap-3 text-sm">
                  <input
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                    [checked]="completeTaskForm().actions.reinstallation"
                    [disabled]="shouldDisableHighPriorityActions() && !completeTaskForm().actions.reinstallation"
                    (change)="toggleCompletionAction('reinstallation', $any($event.target).checked)"
                  />
                  <div class="flex-1">
                    <p class="font-semibold text-slate-900">Reinstallation</p>
                    <p class="text-xs text-slate-500">
                      Existing hardware moved and re-commissioned.
                    </p>
                  </div>
                </label>

                @if (completeTaskForm().actions.reinstallation) {
                  @if (completeInventoryState().error?.includes('add')) {
                    <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                      {{ completeInventoryState().error }}
                    </div>
                  }

                  @if (!hasAvailableAddItems()) {
                    <div class="rounded-2xl border border-dashed border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                      You have no spare materials assigned to you.
                    </div>
                  } @else {
                    <div class="space-y-3">
                      @for (item of availableAddItems(); track item._id) {
                        <label
                          class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm shadow-sm transition hover:border-indigo-300"
                        >
                          <input
                            type="checkbox"
                            class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                            [checked]="isAddItemSelected(item._id)"
                            (change)="toggleAddItemSelection(item._id, $any($event.target).checked)"
                          />
                          <div class="flex-1 space-y-1">
                            <p class="font-semibold text-slate-900">
                              {{ inventoryShortLabel(item) }}
                            </p>
                            <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Type: {{ item.device?.type || 'Unknown type' }}
                              </span>
                              @if (item.device?.model) {
                                <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                  Model: {{ item.device?.model }}
                                </span>
                              }
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1">
                                Serial: {{ item.device?.serialNumber || item._id }}
                              </span>
                            </div>
                          </div>
                        </label>
                      }
                    </div>
                  }
                }
              </div>
            </div>
          </section>

          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Completion comment</span>
            <textarea
              rows="4"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [value]="completeTaskForm().comment"
              (input)="onCompleteTaskCommentChange($any($event.target).value)"
              placeholder="Describe what was done, parts used, or any follow-up requirements."
            ></textarea>
            <span class="text-xs text-slate-400">
              {{ completeTaskForm().comment.trim().length }} / {{ completionCommentMin }} chars
            </span>
          </label>

          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
              (click)="closeCompleteTaskModal()"
              [disabled]="completeTaskForm().isSaving"
            >
              Cancel
            </button>
            <button
              type="button"
              class="inline-flex items-center rounded-2xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-300 transition hover:bg-emerald-500 disabled:cursor-not-allowed disabled:opacity-60"
              (click)="saveCompleteTask()"
              [disabled]="completeTaskForm().isSaving"
            >
              <span>{{ completeTaskForm().isSaving ? 'Saving…' : 'Complete task' }}</span>
            </button>
          </div>
        </div>
        </div>
      </div>
    </div>
  }

  @if (installMaterialsModal()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/60 backdrop-blur-sm">
      <div class="relative w-full max-w-4xl rounded-3xl bg-white shadow-2xl">
        <button
          type="button"
          class="absolute right-4 top-4 rounded-full border border-slate-200 bg-white p-2 text-slate-500 transition hover:text-slate-900"
          (click)="closeInstallMaterialsModal()"
          [disabled]="installMaterialsState().isSaving"
        >
          <span class="sr-only">Close modal</span>
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path
              d="M6.28 5.22a.75.75 0 10-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 10-1.06-1.06L10 8.94 6.28 5.22z"
            />
          </svg>
        </button>

        <div class="max-h-[80vh] overflow-y-auto p-8">
          <div class="space-y-6">
          <header>
            <h2 class="text-xl font-semibold text-slate-900">Install camera materials</h2>
            <p class="mt-1 text-sm text-slate-500">
              Assign materials from available inventory to camera {{ installMaterialsModal()?.cameraName }}.
            </p>
          </header>

          @if (installMaterialsState().error) {
            <div class="rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700">
              {{ installMaterialsState().error }}
            </div>
          }

          @if (installMaterialsState().isLoading) {
            <div class="flex items-center justify-center rounded-2xl border border-slate-200 bg-slate-50 p-6 text-sm text-slate-500">
              Loading inventory…
            </div>
          } @else {
            @if (installMaterialsState().cameraHasInventory) {
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
                This camera already has materials assigned. Use the replacement workflow to swap hardware.
              </div>
            } @else if (installMaterialsState().grouped.length === 0) {
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
                There are no unassigned materials available to install right now.
              </div>
            } @else {
              <div class="space-y-4">
                @for (group of installMaterialsState().grouped; track group.type) {
                  <section class="rounded-3xl border border-slate-200 bg-white p-4 shadow-sm">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                      <div class="flex items-center gap-2">
                        <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-indigo-600">
                          {{ group.type }}
                        </span>
                        <span class="text-xs text-slate-500">
                          {{ group.items.length }} available
                        </span>
                      </div>
                      <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span>Install?</span>
                        <label class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 transition hover:border-indigo-300">
                          <input
                            type="checkbox"
                            class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                            [checked]="isDeviceTypeSelected(group.type)"
                            (change)="toggleDeviceTypeSelection(group.type, $any($event.target).checked)"
                            [disabled]="installMaterialsState().isSaving"
                          />
                          <span>Enable</span>
                        </label>
                      </div>
                    </div>

                    <div class="mt-3 grid gap-3 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)]">
                      <div class="space-y-2 text-xs text-slate-500">
                        <span class="font-semibold text-slate-700">Select inventory</span>
                        <select
                          class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                          [value]="selectedDeviceTypeOption(group.type) ?? ''"
                          (change)="setDeviceTypeSelection(group.type, $any($event.target).value)"
                          [disabled]="!isDeviceTypeSelected(group.type) || installMaterialsState().isSaving"
                        >
                          <option value="">No installation (keep unassigned)</option>
                          @for (item of group.items; track item._id) {
                            <option [value]="item._id">
                              {{ inventoryShortLabel(item) }}
                            </option>
                          }
                        </select>
                        <p class="text-[11px] text-slate-400">
                          Optional — leave as “No installation” to skip this device type.
                        </p>
                      </div>

                      <div class="flex flex-col gap-2 rounded-2xl border border-dashed border-slate-200 bg-slate-50 p-3 text-xs text-slate-500">
                        <span class="font-semibold text-slate-700">Device details</span>
                        <div class="flex flex-wrap gap-2">
                          @if (group.selected) {
                            <ng-container>
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                                Model: {{ group.selectedModel || 'Unknown' }}
                              </span>
                              <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                                Serial: {{ group.selectedSerial }}
                              </span>
                            </ng-container>
                          } @else {
                            <span class="text-[11px] italic text-slate-400">Nothing selected.</span>
                          }
                        </div>
                      </div>
                    </div>
                  </section>
                }
              </div>

              <label class="flex flex-col gap-2 text-sm text-slate-600">
                <span class="font-semibold text-slate-800">Installation notes (optional)</span>
                <textarea
                  rows="3"
                  class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  [value]="installMaterialsState().reason"
                  (input)="setInstallReason($any($event.target).value)"
                  placeholder="Add any context for the installation (e.g., initial setup, replacement stock)."
                  [disabled]="isInstallSelectionDisabled()"
                ></textarea>
              </label>
            }
          }

          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
              (click)="closeInstallMaterialsModal()"
              [disabled]="installMaterialsState().isSaving"
            >
              Cancel
            </button>
            <button
              type="button"
              class="inline-flex items-center rounded-2xl bg-amber-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-amber-200 transition hover:bg-amber-500 disabled:cursor-not-allowed disabled:opacity-60"
              (click)="saveInstallMaterials()"
              [disabled]="installMaterialsState().isSaving || installMaterialsState().cameraHasInventory || installMaterialsState().grouped.length === 0"
            >
              <span>{{ installMaterialsState().isSaving ? 'Installing…' : 'Install materials' }}</span>
              @if (installMaterialsState().isSaving) {
                <span class="ml-2 h-3 w-3 animate-spin rounded-full border border-white border-t-transparent"></span>
              }
            </button>
          </div>
        </div>
        </div>
      </div>
    </div>
  }

</section>
