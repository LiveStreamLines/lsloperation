<section class="space-y-8">
  <header class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900">Memory vault</h1>
      <p class="mt-1 text-sm text-slate-500">
        Monitor capture storage status across developers, projects and cameras.
      </p>
    </div>
    <div class="flex items-center gap-2 text-sm text-slate-500">
      <span class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold uppercase tracking-wide">
        Role: {{ memoryRole() ? (memoryRole() | titlecase) : 'Viewer' }}
      </span>
      <span class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold uppercase tracking-wide">
        User: {{ userName() }}
      </span>
    </div>
  </header>

  @if (errorMessage()) {
    <div class="rounded-3xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      {{ errorMessage() }}
    </div>
  }

  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-5">
    @for (card of metricCards(); track card.title) {
      <article
        class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm transition hover:border-slate-300 hover:shadow-md"
      >
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{ card.title }}</p>
        <p class="mt-3 text-2xl font-semibold text-slate-900">{{ card.value }}</p>
        <p
          class="mt-2 text-xs font-medium uppercase tracking-wide"
          [ngClass]="
            card.tone === 'positive'
              ? 'text-emerald-600'
              : card.tone === 'warning'
                ? 'text-amber-600'
                : 'text-slate-500'
          "
        >
          {{ card.helper }}
        </p>
      </article>
    }
  </div>

  <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-col gap-4 border-b border-slate-100 pb-5">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap gap-2">
          @for (option of statusOptions(); track option.value) {
            <button
              type="button"
              class="inline-flex items-center rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide transition"
              [ngClass]="
                (option.value === 'all' && !selectedStatus()) ||
                (option.value !== 'all' && selectedStatus() === option.value)
                  ? 'border-indigo-500 bg-indigo-600 text-white shadow-lg shadow-indigo-300'
                  : 'border-slate-200 bg-white text-slate-600 hover:bg-slate-50'
              "
              (click)="onStatusChange(option.value)"
              [disabled]="statusOptions().length === 1"
            >
              {{ option.label }}
            </button>
          }
        </div>

        @if (showLowMemoryToggle()) {
          <button
            type="button"
            class="inline-flex items-center gap-3 rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-indigo-300 hover:text-indigo-600"
            [attr.aria-pressed]="showLowMemoryOnly()"
            (click)="toggleLowMemoryOnly(!showLowMemoryOnly())"
          >
            <span>Low storage &lt; 10GB</span>
            <span
              class="relative inline-flex h-5 w-10 items-center rounded-full transition"
              [ngClass]="showLowMemoryOnly() ? 'bg-indigo-500' : 'bg-slate-300'"
            >
              <span
              class="inline-block h-4 w-4 rounded-full bg-white shadow transition transform"
                [ngClass]="showLowMemoryOnly() ? 'translate-x-5' : 'translate-x-1'"
              ></span>
            </span>
          </button>
        }
      </div>
    </div>

    <div class="mt-6 grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <label class="flex flex-col gap-2 text-sm text-slate-600">
        <span class="font-semibold text-slate-800">Developer</span>
        <select
          class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          [value]="selectedDeveloper() ?? ''"
          (change)="onDeveloperChange($any($event.target).value)"
        >
          <option value="">All developers</option>
          @for (option of developerOptions(); track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>

      <label class="flex flex-col gap-2 text-sm text-slate-600">
        <span class="font-semibold text-slate-800">Project</span>
        <select
          class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
          [value]="selectedProject() ?? ''"
          [disabled]="!selectedDeveloper()"
          (change)="onProjectChange($any($event.target).value)"
        >
          <option value="">All projects</option>
          @for (option of projectOptions(); track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>

      <label class="flex flex-col gap-2 text-sm text-slate-600">
        <span class="font-semibold text-slate-800">Camera</span>
        <select
          class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
          [value]="selectedCamera() ?? ''"
          [disabled]="!selectedProject()"
          (change)="onCameraChange($any($event.target).value)"
        >
          <option value="">All cameras</option>
          @for (option of cameraOptions(); track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>

    </div>

    <div class="mt-6 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900"
        (click)="clearFilters()"
      >
        <svg viewBox="0 0 20 20" class="h-4 w-4 fill-current">
          <path
            d="M12.146 7.854a.5.5 0 0 1 0-.708L14.293 5H6.5a.5.5 0 0 1 0-1h7.793l-2.147-2.146a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0zM7.854 12.146a.5.5 0 0 1 0 .708L5.707 15H13.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0z"
          />
        </svg>
        Reset filters
      </button>
    </div>
  </div>

  @if (isLoading()) {
    <div class="rounded-3xl border border-slate-200 bg-white p-10 text-center text-sm text-slate-500 shadow-sm">
      Loading memories…
    </div>
  } @else {
    @if (filteredMemories().length === 0) {
      <div class="rounded-3xl border border-dashed border-slate-200 bg-white p-16 text-center shadow-sm">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-slate-100 text-slate-400">
          <svg viewBox="0 0 24 24" class="h-6 w-6 fill-current">
            <path
              d="M12 5a7 7 0 0 1 7 7v.586l.707.707a1 1 0 0 1 0 1.414L16 18.414V19a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-.586l-3.707-3.707a1 1 0 0 1 0-1.414L5 12.586V12a7 7 0 0 1 7-7zm0 2a5 5 0 0 0-5 5v1a1 1 0 0 1-.293.707L5.414 14 8 16.586V18h8v-1.414L18.586 14l-1.293-1.293A1 1 0 0 1 17 12v-1a5 5 0 0 0-5-5zm0 4a1 1 0 0 1 1 1v1a1 1 0 0 1-2 0v-1a1 1 0 0 1 1-1z"
            />
          </svg>
        </div>
        <h3 class="mt-6 text-lg font-semibold text-slate-900">No memories found</h3>
        <p class="mt-2 text-sm text-slate-500">Try adjusting the filters to see more results.</p>
      </div>
    } @else {
      <div class="overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
              <tr class="text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                <th class="px-6 py-3">Developer</th>
                <th class="px-6 py-3">Project</th>
                <th class="px-6 py-3">Camera</th>
                <th class="px-6 py-3">Pictures</th>
                <th class="px-6 py-3">Memory</th>
                <th class="px-6 py-3">Status</th>
                <th class="px-6 py-3">Timeline</th>
                <th class="px-6 py-3">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white text-sm text-slate-600">
              @for (memory of filteredMemories(); track memory.id) {
                <tr class="transition hover:bg-slate-50/70">
                  <td class="px-6 py-4">
                    <div class="flex flex-col">
                      <span class="font-semibold text-slate-900">{{ memory.developerLabel }}</span>
                      <span class="text-xs uppercase tracking-wide text-slate-400">{{ memory.developerTag }}</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex flex-col">
                      <span class="font-semibold text-slate-900">{{ memory.projectLabel }}</span>
                      <span class="text-xs uppercase tracking-wide text-slate-400">{{ memory.projectTag }}</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex flex-col">
                      <span class="font-semibold text-slate-900">{{ memory.cameraLabel }}</span>
                      <span class="text-xs uppercase tracking-wide text-slate-400">{{ memory.cameraTag }}</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <span>{{ memory.numberOfPictures ?? '—' }}</span>
                      @if (memory.shutterCount !== null) {
                        <span class="text-xs text-slate-400">Shutter: {{ memory.shutterCount }}</span>
                      }
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex flex-col">
                      <span>{{ memory.memoryUsed ?? '—' }} used</span>
                      <span
                        [ngClass]="
                          isLowMemory(memory)
                            ? 'text-xs font-semibold text-amber-600'
                            : 'text-xs text-slate-400'
                        "
                      >
                        {{ memory.memoryAvailable ?? '—' }} available
                      </span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <span
                      class="inline-flex items-center rounded-full px-3 py-1 text-[11px] font-semibold uppercase tracking-wide"
                      [ngClass]="
                        statusTone(memory.status) === 'positive'
                          ? 'bg-emerald-50 text-emerald-700'
                          : statusTone(memory.status) === 'warning'
                            ? 'bg-amber-50 text-amber-700'
                            : 'bg-slate-100 text-slate-600'
                      "
                    >
                      {{ memory.status | titlecase }}
                    </span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="space-y-1">
                      <p class="text-xs text-slate-500">
                        Start:
                        <span class="font-semibold text-slate-700">
                          {{ memory.startDate ? (memory.startDate | date: 'shortDate') : '—' }}
                        </span>
                      </p>
                      <p class="text-xs text-slate-500">
                        End:
                        <span class="font-semibold text-slate-700">
                          {{ memory.endDisplayDate ? (memory.endDisplayDate | date: 'shortDate') : '—' }}
                        </span>
                        @if (memory.endSource === 'removed') {
                          <span class="ml-2 text-amber-600">(Removed)</span>
                        } @else if (memory.endSource === 'archived') {
                          <span class="ml-2 text-emerald-600">(Archived)</span>
                        }
                      </p>
                      @if (memory.dateOfRemoval) {
                        <p class="text-xs text-amber-600">
                          Removed: {{ memory.dateOfRemoval | date: 'shortDate' }}
                          <span class="text-slate-400">by {{ memory.removalUser ?? '—' }}</span>
                        </p>
                      }
                      @if (memory.dateOfReceive) {
                        <p class="text-xs text-emerald-600">
                          Archived: {{ memory.dateOfReceive | date: 'shortDate' }}
                          <span class="text-slate-400">by {{ memory.receiveUser ?? '—' }}</span>
                        </p>
                      }
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <!-- Temporarily hidden - Remove button -->
                      <!-- <button
                        type="button"
                        class="inline-flex items-center gap-2 rounded-full border border-amber-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-amber-600 transition hover:border-amber-300 hover:bg-amber-50 disabled:cursor-not-allowed disabled:opacity-60"
                        (click)="updateMemoryStatus(memory, 'removed')"
                        [disabled]="!canMarkRemoved(memory) || isUpdating(memory.id)"
                      >
                        @if (isUpdating(memory.id)) {
                          <span class="h-2.5 w-2.5 animate-spin rounded-full border border-current border-t-transparent"></span>
                        } @else {
                          <svg viewBox="0 0 20 20" class="h-3.5 w-3.5 fill-current">
                            <path
                              d="M4 2.5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 9 3.5V4h5.5a.5.5 0 0 1 0 1h-.523l-.92 10.337A2 2 0 0 1 11.065 17H6.935a2 2 0 0 1-1.492-.663L4.523 5H4.5a.5.5 0 0 1 0-1H5v-.5a.5.5 0 0 1 1 0V4h4v-.5a.5.5 0 0 0-.5-.5h-3A.5.5 0 0 1 6 2.5V3H4.5a.5.5 0 0 1-.5-.5Z"
                            />
                          </svg>
                        }
                        Remove
                      </button> -->
                      <button
                        type="button"
                        class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-600 transition hover:border-emerald-300 hover:bg-emerald-50 disabled:cursor-not-allowed disabled:opacity-60"
                        (click)="updateMemoryStatus(memory, 'archived')"
                        [disabled]="!canMarkArchived(memory) || isUpdating(memory.id)"
                      >
                        @if (isUpdating(memory.id)) {
                          <span class="h-2.5 w-2.5 animate-spin rounded-full border border-current border-t-transparent"></span>
                        } @else {
                          <svg viewBox="0 0 20 20" class="h-3.5 w-3.5 fill-current">
                            <path
                              d="M10 2a1 1 0 0 1 .832.445l6 9A1 1 0 0 1 16 13H4a1 1 0 0 1-.832-1.555l6-9A1 1 0 0 1 10 2Zm0 2.236L5.618 11H14.382L10 4.236ZM4 14a1 1 0 0 1 1-1h10a1 1 0 0 1 0 2H5a1 1 0 0 1-1-1Z"
                            />
                          </svg>
                        }
                        Archive
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  }
</section>
