<section class="space-y-6">
  <header class="flex flex-col gap-3 rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <p class="text-sm font-semibold uppercase tracking-wide text-indigo-500">User management</p>
        <h1 class="mt-1 text-3xl font-bold text-slate-900">
          {{ isEditMode() ? 'Edit User' : 'Add New User' }}
        </h1>
      </div>
    </div>
  </header>

  @if (isLoading()) {
    <div class="flex items-center justify-center rounded-3xl bg-white p-12 shadow-sm ring-1 ring-slate-200">
      <div class="text-center">
        <div class="mx-auto h-8 w-8 animate-spin rounded-full border-4 border-indigo-200 border-t-indigo-600"></div>
        <p class="mt-4 text-sm text-slate-600">Loading...</p>
      </div>
    </div>
  } @else if (submitted()) {
    <div class="rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
      <div class="mb-6 rounded-2xl bg-emerald-50 p-4 text-sm text-emerald-700 ring-1 ring-emerald-200">
        <h3 class="font-semibold">User {{ isEditMode() ? 'updated' : 'added' }} successfully!</h3>
      </div>

      <fieldset class="space-y-4 rounded-2xl border border-slate-200 p-6">
        <legend class="px-2 text-sm font-semibold text-slate-700">Adjust Password</legend>
        <div class="flex flex-wrap items-end gap-4">
          <label class="flex flex-1 flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Send the password link to Email:</span>
            <input
              type="text"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [value]="resetEmail()"
              (input)="resetEmail.set($any($event.target).value)"
            />
          </label>
          <button
            type="button"
            class="rounded-2xl bg-indigo-600 px-6 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-200 transition hover:bg-indigo-500"
            (click)="sendResetPasswordLink()"
          >
            Send Password Link
          </button>
        </div>
      </fieldset>

      @if (isEditMode()) {
        <div class="mt-6">
          <button
            type="button"
            class="rounded-2xl border border-slate-200 bg-white px-6 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50"
            (click)="useCurrentPassword()"
          >
            Use Current Password
          </button>
        </div>
      }
    </div>
  } @else {
    <div class="rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
      <form class="space-y-8" (ngSubmit)="saveUser()">
        <!-- User Info Section -->
        <fieldset class="space-y-4 rounded-2xl border border-slate-200 p-6">
          <legend class="px-2 text-sm font-semibold text-slate-700">User Info</legend>
          <div class="grid gap-4 md:grid-cols-3">
            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Name <span class="text-rose-500">*</span></span>
              <input
                type="text"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                [ngModel]="userForm().name"
                (ngModelChange)="updateFormField('name', $event)"
                [ngModelOptions]="{standalone: true}"
                required
              />
            </label>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Email <span class="text-rose-500">*</span></span>
              <input
                type="email"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                [ngModel]="userForm().email"
                (ngModelChange)="updateFormField('email', $event)"
                [ngModelOptions]="{standalone: true}"
                [disabled]="isEditMode() && !isSuperAdmin()"
                required
              />
            </label>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Phone</span>
              <input
                type="text"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                [ngModel]="userForm().phone"
                (ngModelChange)="updateFormField('phone', $event)"
                [ngModelOptions]="{standalone: true}"
                [disabled]="!isSuperAdmin()"
              />
            </label>

            <div class="flex flex-col gap-3 md:col-span-3">
              <span class="font-semibold text-slate-800">Profile Image</span>
              <div class="flex flex-col gap-4 md:flex-row md:items-center">
                <div class="flex h-16 w-16 items-center justify-center overflow-hidden rounded-full border-2 border-slate-200 bg-slate-100">
                  @if (userForm().imagePreview) {
                    <img
                      [src]="userForm().imagePreview"
                      [alt]="userForm().name || 'User'"
                      class="h-full w-full object-cover"
                      (error)="$any($event.target).style.display='none'; $any($event.target).nextElementSibling.style.display='flex';"
                    />
                    <div class="hidden h-full w-full items-center justify-center bg-slate-200 text-xs text-slate-500">
                      {{ (userForm().name && userForm().name.charAt(0)) || 'U' }}
                    </div>
                  } @else {
                    <div class="flex h-full w-full items-center justify-center bg-indigo-100 text-sm font-semibold text-indigo-600">
                      {{ (userForm().name && userForm().name.charAt(0)) || 'U' }}
                    </div>
                  }
                </div>
                <div class="flex flex-1 flex-col gap-2">
                  <input
                    type="file"
                    accept="image/*"
                    class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    (change)="onImageSelect($event)"
                  />
                  @if (userForm().imagePreview || userForm().imageFile || userForm().image) {
                    <button
                      type="button"
                      class="self-start text-xs font-semibold text-rose-600 hover:text-rose-500"
                      (click)="clearImage()"
                    >
                      Remove image
                    </button>
                  }
                </div>
              </div>
              <p class="text-xs text-slate-500">Upload a square image (JPG or PNG) to personalize the user avatar.</p>
            </div>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Role <span class="text-rose-500">*</span></span>
              <select
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                [ngModel]="userForm().role"
                (ngModelChange)="onRoleChange($event)"
                [ngModelOptions]="{standalone: true}"
                [disabled]="!isSuperAdmin()"
                required
              >
                @for (role of roles; track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
            </label>
          </div>
        </fieldset>

        <!-- Camera access Section -->
        <fieldset class="space-y-4 rounded-2xl border border-slate-200 p-6">
          <legend class="px-2 text-sm font-semibold text-slate-700">Camera access</legend>
          @if (!hidePermissions()) {
            <div class="space-y-4">
              <!-- Region access (Admin) -->
              @if (showAdminRoles()) {
                <div class="grid gap-4 md:grid-cols-2">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().hasUaeAccess"
                      (ngModelChange)="onRegionAccessChange('uae', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>UAE access</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().hasSaudiAccess"
                      (ngModelChange)="onRegionAccessChange('saudi', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Saudi access</span>
                  </label>
                </div>
              }

              <div class="grid gap-4 md:grid-cols-2">
                <!-- Accessible Developers -->
                <label class="flex flex-col gap-2 text-sm text-slate-600">
                <span class="font-semibold text-slate-800">Accessible Developers</span>
                <div class="relative multi-select-dropdown md:w-1/2">
                  <button
                    type="button"
                    class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs shadow-sm transition hover:border-slate-300 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    (click)="toggleDeveloperDropdown()"
                  >
                    <span class="text-slate-600">
                      @if (userForm().accessibleDevelopers.length === 0) {
                        Select developers...
                      } @else if (isAllDevSelected()) {
                        All Developers
                      } @else {
                        {{ userForm().accessibleDevelopers.length }} selected
                      }
                    </span>
                    <svg
                      class="h-5 w-5 text-slate-400 transition-transform"
                      [class.rotate-180]="isDeveloperDropdownOpen()"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  @if (isDeveloperDropdownOpen()) {
                    <div
                      class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-2xl border border-slate-200 bg-white shadow-lg ring-1 ring-black ring-opacity-5"
                    >
                      <div class="p-2">
                        @if (isSuperAdmin()) {
                          <label
                            class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-slate-50"
                            (click)="toggleDeveloperSelection('all')"
                          >
                            <input
                              type="checkbox"
                              class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                              [checked]="isAllDevSelected()"
                              (change)="$event.stopPropagation()"
                            />
                            <span class="font-semibold text-slate-700">All</span>
                          </label>
                        }
                        @for (developer of filteredDevelopers(); track developer._id) {
                          <label
                            class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-slate-50"
                            (click)="toggleDeveloperSelection(developer._id)"
                          >
                            <input
                              type="checkbox"
                              class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                              [checked]="isDeveloperSelected(developer._id)"
                              (change)="$event.stopPropagation()"
                            />
                            <span class="text-slate-700">{{ developer.developerName }}</span>
                          </label>
                        }
                      </div>
                    </div>
                  }
                </div>
                @if (userForm().accessibleDevelopers.length > 0) {
                  <div class="flex flex-wrap gap-2">
                    @for (devId of userForm().accessibleDevelopers; track devId) {
                      <span
                        class="inline-flex items-center gap-1.5 rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700"
                      >
                        {{ getDeveloperLabel(devId) }}
                        <button
                          type="button"
                          class="rounded-full hover:bg-indigo-200"
                          (click)="removeDeveloper(devId)"
                        >
                          <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                            <path
                              fill-rule="evenodd"
                              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </button>
                      </span>
                    }
                  </div>
                }
                </label>

                <!-- Accessible Projects -->
                @if (filteredProjects().length > 0 || isAllProjSelected()) {
                  <label class="flex flex-col gap-2 text-sm text-slate-600">
                  <span class="font-semibold text-slate-800">Accessible Projects</span>
                  <div class="relative multi-select-dropdown md:w-1/2">
                    <button
                      type="button"
                      class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs shadow-sm transition hover:border-slate-300 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      (click)="toggleProjectDropdown()"
                    >
                      <span class="text-slate-600">
                        @if (userForm().accessibleProjects.length === 0) {
                          Select projects...
                        } @else if (isAllProjSelected()) {
                          All Projects
                        } @else {
                          {{ userForm().accessibleProjects.length }} selected
                        }
                      </span>
                      <svg
                        class="h-5 w-5 text-slate-400 transition-transform"
                        [class.rotate-180]="isProjectDropdownOpen()"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    @if (isProjectDropdownOpen()) {
                      <div
                        class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-2xl border border-slate-200 bg-white shadow-lg ring-1 ring-black ring-opacity-5"
                      >
                        <div class="p-2">
                          @if (isSuperAdmin() || accessibleProjects()[0] === 'all') {
                            <label
                              class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-slate-50"
                              (click)="toggleProjectSelection('all')"
                            >
                              <input
                                type="checkbox"
                                class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                                [checked]="isAllProjSelected()"
                                (change)="$event.stopPropagation()"
                              />
                              <span class="font-semibold text-slate-700">All</span>
                            </label>
                          }
                          @for (project of filteredProjects(); track project._id) {
                            <label
                              class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-slate-50"
                              (click)="toggleProjectSelection(project._id)"
                            >
                              <input
                                type="checkbox"
                                class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                                [checked]="isProjectSelected(project._id)"
                                (change)="$event.stopPropagation()"
                              />
                              <span class="text-slate-700">{{ project.projectName }}</span>
                            </label>
                          }
                        </div>
                      </div>
                    }
                  </div>
                  @if (userForm().accessibleProjects.length > 0) {
                    <div class="flex flex-wrap gap-2">
                      @for (projId of userForm().accessibleProjects; track projId) {
                        <span
                          class="inline-flex items-center gap-1.5 rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700"
                        >
                          {{ getProjectLabel(projId) }}
                          <button
                            type="button"
                            class="rounded-full hover:bg-indigo-200"
                            (click)="removeProject(projId)"
                          >
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                              <path
                                fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"
                              />
                            </svg>
                          </button>
                        </span>
                      }
                    </div>
                  }
                  </label>
                }

                <!-- Accessible Cameras -->
                @if (filteredCameras().length > 0 || isAllCameraSelected()) {
                  <label class="flex flex-col gap-2 text-sm text-slate-600">
                  <span class="font-semibold text-slate-800">Accessible Cameras</span>
                  <div class="relative multi-select-dropdown md:w-1/2">
                    <button
                      type="button"
                      class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs shadow-sm transition hover:border-slate-300 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      (click)="toggleCameraDropdown()"
                    >
                      <span class="text-slate-600">
                        @if (userForm().accessibleCameras.length === 0) {
                          Select cameras...
                        } @else if (isAllCameraSelected()) {
                          All Cameras
                        } @else {
                          {{ userForm().accessibleCameras.length }} selected
                        }
                      </span>
                      <svg
                        class="h-5 w-5 text-slate-400 transition-transform"
                        [class.rotate-180]="isCameraDropdownOpen()"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    @if (isCameraDropdownOpen()) {
                      <div
                        class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-2xl border border-slate-200 bg-white shadow-lg ring-1 ring-black ring-opacity-5"
                      >
                        <div class="p-2">
                          @if (isSuperAdmin() || accessibleCameras()[0] === 'all') {
                            <label
                              class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-slate-50"
                              (click)="toggleCameraSelection('all')"
                            >
                              <input
                                type="checkbox"
                                class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                                [checked]="isAllCameraSelected()"
                                (change)="$event.stopPropagation()"
                              />
                              <span class="font-semibold text-slate-700">All</span>
                            </label>
                          }
                          @for (camera of filteredCameras(); track camera._id) {
                            <label
                              class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-slate-50"
                              (click)="toggleCameraSelection(camera._id)"
                            >
                              <input
                                type="checkbox"
                                class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                                [checked]="isCameraSelected(camera._id)"
                                (change)="$event.stopPropagation()"
                              />
                              <span class="text-slate-700">{{ camera.camera || camera.cameraDescription || 'â€”' }}</span>
                            </label>
                          }
                        </div>
                      </div>
                    }
                  </div>
                  @if (userForm().accessibleCameras.length > 0) {
                    <div class="flex flex-wrap gap-2">
                      @for (camId of userForm().accessibleCameras; track camId) {
                        <span
                          class="inline-flex items-center gap-1.5 rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700"
                        >
                          {{ getCameraLabel(camId) }}
                          <button
                            type="button"
                            class="rounded-full hover:bg-indigo-200"
                            (click)="removeCamera(camId)"
                          >
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                              <path
                                fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"
                              />
                            </svg>
                          </button>
                        </span>
                      }
                    </div>
                  }
                  </label>
                }
              </div>

              <!-- Can Generate Video and Pics is always true and hidden -->
            </div>
          }
        </fieldset>

        <!-- Operation permissions (Admin only) -->
        @if (showAdminRoles()) {
          <fieldset class="space-y-5 rounded-2xl border border-slate-200 p-6">
            <legend class="px-2 text-sm font-semibold text-slate-700">Operation permissions</legend>

            <!-- Manage Developers / Projects / Cameras -->
            <div class="space-y-2">
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().canManageDevProjCam"
                    (ngModelChange)="updateFormField('canManageDevProjCam', $event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>Manage Developer / Project / Cameras</span>
                </label>
              </div>
            </div>

            <!-- Camera monitor permissions -->
            <div class="space-y-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Camera monitor</h3>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().hasCameraMonitorAccess"
                    (ngModelChange)="onCameraMonitorAccessChange($event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>Camera monitor</span>
                </label>
              </div>

              @if (userForm().hasCameraMonitorAccess) {
                <div class="mt-2 space-y-2 pl-6">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canCreateMonitorTask"
                      (ngModelChange)="updateFormField('canCreateMonitorTask', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Create task</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canHoldMaintenance"
                      (ngModelChange)="updateFormField('canHoldMaintenance', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Hold tasks</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canDeletePhoto"
                      (ngModelChange)="updateFormField('canDeletePhoto', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Delete photos</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canSeeAllTasks"
                      (ngModelChange)="updateFormField('canSeeAllTasks', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>See all the tasks</span>
                  </label>
                </div>
              }
            </div>

            <!-- Inventory permissions -->
            <div class="space-y-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Inventory</h3>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().hasInventoryAccess"
                    (ngModelChange)="onInventoryAccessChange($event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>Inventory</span>
                </label>
              </div>

              @if (userForm().hasInventoryAccess) {
                <div class="mt-2 space-y-2 pl-6">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canAddDeviceType"
                      (ngModelChange)="updateFormField('canAddDeviceType', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Add device type</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canAddDeviceStock"
                      (ngModelChange)="updateFormField('canAddDeviceStock', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Add device stock</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canAssignUnassignUser"
                      (ngModelChange)="updateFormField('canAssignUnassignUser', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Assign / unassign user</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canAssignUnassignProject"
                      (ngModelChange)="updateFormField('canAssignUnassignProject', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Assign / unassign project</span>
                  </label>
                </div>
              }
            </div>

            <!-- Memory permissions -->
            <div class="space-y-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Memory</h3>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().hasMemoryAccess"
                    (ngModelChange)="onMemoryAccessChange($event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>Memory</span>
                </label>
              </div>

              @if (userForm().hasMemoryAccess) {
                <div class="mt-2 space-y-2 pl-6">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canArchiveMemory"
                      (ngModelChange)="updateFormField('canArchiveMemory', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Archive memory</span>
                  </label>
                </div>
              }
            </div>

          </fieldset>
        }

        @if (userForm().error) {
          <div class="rounded-2xl bg-rose-50 p-4 text-sm text-rose-700 ring-1 ring-rose-200">
            {{ userForm().error }}
          </div>
        }

        <div class="flex items-center justify-end gap-4">
          <button
            type="button"
            class="rounded-2xl border border-slate-200 px-6 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50"
            (click)="cancel()"
            [disabled]="userForm().isSaving"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="rounded-2xl bg-indigo-600 px-6 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-200 transition hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
            [disabled]="userForm().isSaving"
          >
            @if (userForm().isSaving) {
              <span class="inline-flex items-center gap-2">
                <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
                Saving...
              </span>
            } @else {
              {{ isEditMode() ? 'Update User' : 'Add User' }}
            }
          </button>
        </div>
      </form>
    </div>
  }
</section>

