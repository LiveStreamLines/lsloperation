<section class="space-y-6">
  <header class="flex flex-col gap-3 rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <p class="text-sm font-semibold uppercase tracking-wide text-indigo-500">User management</p>
        <h1 class="mt-1 text-3xl font-bold text-slate-900">
          {{ isEditMode() ? 'Edit User' : 'Add New User' }}
        </h1>
      </div>
    </div>
  </header>

  @if (isLoading()) {
    <div class="flex items-center justify-center rounded-3xl bg-white p-12 shadow-sm ring-1 ring-slate-200">
      <div class="text-center">
        <div class="mx-auto h-8 w-8 animate-spin rounded-full border-4 border-indigo-200 border-t-indigo-600"></div>
        <p class="mt-4 text-sm text-slate-600">Loading...</p>
      </div>
    </div>
  } @else if (submitted()) {
    <div class="rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
      <div class="mb-6 rounded-2xl bg-emerald-50 p-4 text-sm text-emerald-700 ring-1 ring-emerald-200">
        <h3 class="font-semibold">User {{ isEditMode() ? 'updated' : 'added' }} successfully!</h3>
      </div>

      <fieldset class="space-y-4 rounded-2xl border border-slate-200 p-6">
        <legend class="px-2 text-sm font-semibold text-slate-700">Adjust Password</legend>
        <div class="flex flex-wrap items-end gap-4">
          <label class="flex flex-1 flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Send the password link to Email:</span>
            <input
              type="text"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [value]="resetEmail()"
              (input)="resetEmail.set($any($event.target).value)"
            />
          </label>
          <button
            type="button"
            class="rounded-2xl bg-indigo-600 px-6 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-200 transition hover:bg-indigo-500"
            (click)="sendResetPasswordLink()"
          >
            Send Password Link
          </button>
        </div>
      </fieldset>

      @if (isEditMode()) {
        <div class="mt-6">
          <button
            type="button"
            class="rounded-2xl border border-slate-200 bg-white px-6 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50"
            (click)="useCurrentPassword()"
          >
            Use Current Password
          </button>
        </div>
      }
    </div>
  } @else {
    <div class="rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
      <form class="space-y-8" (ngSubmit)="saveUser()">
        <!-- User Info Section -->
        <fieldset class="space-y-4 rounded-2xl border border-slate-200 p-6">
          <legend class="px-2 text-sm font-semibold text-slate-700">User Info</legend>
          <div class="grid gap-4 md:grid-cols-3">
            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Name <span class="text-rose-500">*</span></span>
              <input
                type="text"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                [ngModel]="userForm().name"
                (ngModelChange)="updateFormField('name', $event)"
                [ngModelOptions]="{standalone: true}"
                required
              />
            </label>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Email <span class="text-rose-500">*</span></span>
              <input
                type="email"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                [ngModel]="userForm().email"
                (ngModelChange)="updateFormField('email', $event)"
                [ngModelOptions]="{standalone: true}"
                [disabled]="isEditMode() && !isSuperAdmin()"
                required
              />
            </label>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Phone</span>
              <input
                type="text"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                [ngModel]="userForm().phone"
                (ngModelChange)="updateFormField('phone', $event)"
                [ngModelOptions]="{standalone: true}"
                [disabled]="!isSuperAdmin()"
              />
            </label>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">
                Password 
                @if (!isEditMode()) {
                  <span class="text-rose-500">*</span>
                }
              </span>
              <div class="relative">
                <input
                  [type]="showPassword() ? 'text' : 'password'"
                  class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 pr-12 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  [ngModel]="userForm().password"
                  (ngModelChange)="updateFormField('password', $event)"
                  [ngModelOptions]="{standalone: true}"
                  [placeholder]="isEditMode() ? 'Leave blank to keep current password' : 'Enter password (min. 8 characters)'"
                  [required]="!isEditMode()"
                />
                <button
                  type="button"
                  (click)="togglePasswordVisibility()"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 focus:outline-none"
                  aria-label="Toggle password visibility"
                >
                  @if (showPassword()) {
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.29 3.29m13.532 13.532l-3.29-3.29M3 3l18 18" />
                    </svg>
                  } @else {
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  }
                </button>
              </div>
              <p class="text-xs text-slate-500">
                @if (isEditMode()) {
                  Leave blank to keep current password, or enter a new password (min. 8 characters).
                } @else {
                  Password must be at least 8 characters long.
                }
              </p>
            </label>

            <div class="flex flex-col gap-3 md:col-span-3">
              <span class="font-semibold text-slate-800">Profile Image</span>
              <div class="flex flex-col gap-4 md:flex-row md:items-center">
                <div class="flex h-16 w-16 items-center justify-center overflow-hidden rounded-full border-2 border-slate-200 bg-slate-100">
                  @if (userForm().imagePreview) {
                    <img
                      [src]="userForm().imagePreview"
                      [alt]="userForm().name || 'User'"
                      class="h-full w-full object-cover"
                      (error)="$any($event.target).style.display='none'; $any($event.target).nextElementSibling.style.display='flex';"
                    />
                    <div class="hidden h-full w-full items-center justify-center bg-slate-200 text-xs text-slate-500">
                      {{ (userForm().name && userForm().name.charAt(0)) || 'U' }}
                    </div>
                  } @else {
                    <div class="flex h-full w-full items-center justify-center bg-indigo-100 text-sm font-semibold text-indigo-600">
                      {{ (userForm().name && userForm().name.charAt(0)) || 'U' }}
                    </div>
                  }
                </div>
                <div class="flex flex-1 flex-col gap-2">
                  <input
                    type="file"
                    accept="image/*"
                    class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    (change)="onImageSelect($event)"
                  />
                  @if (userForm().imagePreview || userForm().imageFile || userForm().image) {
                    <button
                      type="button"
                      class="self-start text-xs font-semibold text-rose-600 hover:text-rose-500"
                      (click)="clearImage()"
                    >
                      Remove image
                    </button>
                  }
                </div>
              </div>
              <p class="text-xs text-slate-500">Upload a square image (JPG or PNG) to personalize the user avatar.</p>
            </div>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Role <span class="text-rose-500">*</span></span>
              <select
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                [ngModel]="userForm().role"
                (ngModelChange)="onRoleChange($event)"
                [ngModelOptions]="{standalone: true}"
                [disabled]="!isSuperAdmin()"
                required
              >
                @for (role of roles; track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
            </label>

            <label class="flex flex-col gap-2 text-sm text-slate-600">
              <span class="font-semibold text-slate-800">Country</span>
              <select
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
                [ngModel]="userForm().country"
                (ngModelChange)="updateFormField('country', $event)"
                [ngModelOptions]="{standalone: true}"
                [disabled]="isCountryFieldDisabled()"
              >
                @for (option of availableCountryOptions(); track option.value) {
                  <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
            </label>
          </div>
        </fieldset>

        <!-- Operation permissions (Admin only) -->
        @if (showAdminRoles()) {
          <fieldset class="space-y-5 rounded-2xl border border-slate-200 p-6">
            <legend class="px-2 text-sm font-semibold text-slate-700">Operation permissions</legend>

            <!-- Manage Developers / Projects / Cameras -->
            <div class="space-y-2">
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-700">
                  Manage Developer / Project / Cameras
                </label>
                <div class="flex flex-col gap-2">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="radio"
                      name="canManageDevProjCam"
                      class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      value=""
                      [ngModel]="userForm().canManageDevProjCam || ''"
                      (ngModelChange)="updateFormField('canManageDevProjCam', $event === '' ? null : $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>None</span>
                  </label>
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="radio"
                      name="canManageDevProjCam"
                      class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      value="all"
                      [ngModel]="userForm().canManageDevProjCam"
                      (ngModelChange)="updateFormField('canManageDevProjCam', 'all')"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>All</span>
                  </label>
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="radio"
                      name="canManageDevProjCam"
                      class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      value="camera_configuration"
                      [ngModel]="userForm().canManageDevProjCam"
                      (ngModelChange)="updateFormField('canManageDevProjCam', 'camera_configuration')"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Camera Configuration</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Camera monitor permissions -->
            <div class="space-y-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Camera monitor</h3>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().hasCameraMonitorAccess"
                    (ngModelChange)="onCameraMonitorAccessChange($event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>Camera monitor</span>
                </label>
              </div>

              @if (userForm().hasCameraMonitorAccess) {
                <div class="mt-2 space-y-2 pl-6">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canCreateMonitorTask"
                      (ngModelChange)="updateFormField('canCreateMonitorTask', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Create task</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canHoldMaintenance"
                      (ngModelChange)="updateFormField('canHoldMaintenance', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Hold Offline / Maintenance</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canDeletePhoto"
                      (ngModelChange)="updateFormField('canDeletePhoto', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Delete photos</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canTogglePhotoDirtyBetterView"
                      (ngModelChange)="updateFormField('canTogglePhotoDirtyBetterView', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Photo dirty / Better view</span>
                  </label>
                </div>
              }
            </div>

            <!-- Task Management permissions -->
            <div class="space-y-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Task Management</h3>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().canSeeAllTasks"
                    (ngModelChange)="updateFormField('canSeeAllTasks', $event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>See all the tasks</span>
                </label>
              </div>
            </div>

            <!-- Inventory permissions -->
            <div class="space-y-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Inventory</h3>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().hasInventoryAccess"
                    (ngModelChange)="onInventoryAccessChange($event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>Inventory</span>
                </label>
              </div>

              @if (userForm().hasInventoryAccess) {
                <div class="mt-2 space-y-2 pl-6">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canAddDeviceType"
                      (ngModelChange)="updateFormField('canAddDeviceType', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Add device type</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canAddDeviceStock"
                      (ngModelChange)="updateFormField('canAddDeviceStock', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Add device stock</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canSeeAllInventory"
                      (ngModelChange)="updateFormField('canSeeAllInventory', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>See all inventory</span>
                  </label>

                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canAssignToUser"
                      (ngModelChange)="updateFormField('canAssignToUser', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Stock keeper</span>
                  </label>
                </div>
              }
            </div>

            <!-- Memory permissions -->
            <div class="space-y-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Memory</h3>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    [ngModel]="userForm().hasMemoryAccess"
                    (ngModelChange)="onMemoryAccessChange($event)"
                    [ngModelOptions]="{standalone: true}"
                  />
                  <span>Memory</span>
                </label>
              </div>

              @if (userForm().hasMemoryAccess) {
                <div class="mt-2 space-y-2 pl-6">
                  <label class="flex items-center gap-2 text-sm text-slate-700">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                      [ngModel]="userForm().canArchiveMemory"
                      (ngModelChange)="updateFormField('canArchiveMemory', $event)"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span>Archive memory</span>
                  </label>
                </div>
              }
            </div>

          </fieldset>
        }

        @if (userForm().error) {
          <div class="rounded-2xl bg-rose-50 p-4 text-sm text-rose-700 ring-1 ring-rose-200">
            {{ userForm().error }}
          </div>
        }

        <div class="flex items-center justify-end gap-4">
          <button
            type="button"
            class="rounded-2xl border border-slate-200 px-6 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50"
            (click)="cancel()"
            [disabled]="userForm().isSaving"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="rounded-2xl bg-indigo-600 px-6 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-200 transition hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
            [disabled]="userForm().isSaving"
          >
            @if (userForm().isSaving) {
              <span class="inline-flex items-center gap-2">
                <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
                Saving...
              </span>
            } @else {
              {{ isEditMode() ? 'Update User' : 'Add User' }}
            }
          </button>
        </div>
      </form>
    </div>
  }
</section>

