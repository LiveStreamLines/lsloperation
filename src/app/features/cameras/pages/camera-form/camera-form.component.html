<section class="space-y-6">
  <header class="flex flex-col gap-3 rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <p class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Camera management</p>
        <h1 class="mt-1 text-3xl font-bold text-slate-900">
          {{ isEditMode() ? 'Edit Camera' : 'Add New Camera' }}
        </h1>
      </div>
    </div>
  </header>

  @if (isLoading()) {
    <div class="flex items-center justify-center rounded-3xl bg-white p-12 shadow-sm ring-1 ring-slate-200">
      <div class="text-center">
        <div class="mx-auto h-8 w-8 animate-spin rounded-full border-4 border-indigo-200 border-t-indigo-600"></div>
        <p class="mt-4 text-sm text-slate-600">Loading...</p>
      </div>
    </div>
  } @else {
    <div class="rounded-3xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
      <form class="space-y-6" (ngSubmit)="saveCamera()">
        <!-- Developer and Project Selection -->
        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Developer <span class="text-rose-500">*</span></span>
            <select
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
              [ngModel]="cameraForm().developer"
              (ngModelChange)="onDeveloperChange($event)"
              [ngModelOptions]="{standalone: true}"
              [disabled]="isEditMode()"
              required
            >
              <option value="">Select developer</option>
              @for (developer of sortedDevelopers(); track developer._id) {
                <option [value]="developer._id">{{ developer.developerName }}</option>
              }
            </select>
          </label>

          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Project <span class="text-rose-500">*</span></span>
            <select
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
              [ngModel]="cameraForm().project"
              (ngModelChange)="updateFormField('project', $event)"
              [ngModelOptions]="{standalone: true}"
              [disabled]="isEditMode() || !cameraForm().developer"
              required
            >
              <option value="">Select project</option>
              @for (project of filteredProjects(); track project._id) {
                <option [value]="project._id">{{ project.projectName }}</option>
              }
            </select>
          </label>
        </div>

        <!-- Camera Details -->
        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Camera Tag <span class="text-rose-500">*</span></span>
            <input
              type="text"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().camera"
              (ngModelChange)="updateFormField('camera', $event)"
              [ngModelOptions]="{standalone: true}"
              required
            />
          </label>

          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Index <span class="text-rose-500">*</span></span>
            <input
              type="number"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().cindex"
              (ngModelChange)="updateFormField('cindex', +$event)"
              [ngModelOptions]="{standalone: true}"
              required
            />
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Camera Name</span>
            <input
              type="text"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().cameraDescription"
              (ngModelChange)="updateFormField('cameraDescription', $event)"
              [ngModelOptions]="{standalone: true}"
            />
          </label>

          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Server Folder</span>
            <input
              type="text"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().serverFolder"
              (ngModelChange)="updateFormField('serverFolder', $event)"
              [ngModelOptions]="{standalone: true}"
            />
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Latitude <span class="text-rose-500">*</span></span>
            <input
              type="text"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().lat"
              (ngModelChange)="updateFormField('lat', $event)"
              [ngModelOptions]="{standalone: true}"
              required
            />
          </label>

          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Longitude <span class="text-rose-500">*</span></span>
            <input
              type="text"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().lng"
              (ngModelChange)="updateFormField('lng', $event)"
              [ngModelOptions]="{standalone: true}"
              required
            />
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Country <span class="text-rose-500">*</span></span>
            <select
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().country"
              (ngModelChange)="updateFormField('country', $event)"
              [ngModelOptions]="{standalone: true}"
              required
            >
              <option value="">Select country</option>
              @for (country of countryOptions; track country) {
                <option [value]="country">{{ country }}</option>
              }
            </select>
          </label>

          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Server <span class="text-rose-500">*</span></span>
            <select
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().server"
              (ngModelChange)="updateFormField('server', $event)"
              [ngModelOptions]="{standalone: true}"
              required
            >
              <option value="">Select server</option>
              @for (server of serverOptions; track server) {
                <option [value]="server">{{ server }}</option>
              }
            </select>
          </label>
        </div>

        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
            [ngModel]="cameraForm().isActive"
            (ngModelChange)="updateFormField('isActive', $event)"
            [ngModelOptions]="{standalone: true}"
            id="isActive"
          />
          <label for="isActive" class="text-sm font-semibold text-slate-800">Active</label>
        </div>

        <div class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50/60 p-4">
          <div class="flex items-center justify-between text-sm">
            <h4 class="font-semibold text-slate-900">Internal Info</h4>
            <span class="text-xs uppercase tracking-wide text-slate-500">Private</span>
          </div>
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Description</span>
            <textarea
              rows="3"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [ngModel]="cameraForm().internalDescription"
              (ngModelChange)="updateFormField('internalDescription', $event)"
              [ngModelOptions]="{standalone: true}"
            ></textarea>
          </label>
          <div class="space-y-3 text-sm text-slate-600">
            <label class="flex flex-col gap-2">
              <span class="font-semibold text-slate-800">Attachments</span>
              <input
                type="file"
                multiple
                class="rounded-2xl border border-dashed border-slate-300 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                (change)="onInternalAttachmentsChange($event)"
              />
            </label>

            @if (cameraForm().internalAttachments.length > 0) {
              <div class="space-y-2 rounded-2xl border border-slate-200 bg-white p-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">New attachments</p>
                @for (file of cameraForm().internalAttachments; track file.name + file.size + $index; let i = $index) {
                  <div class="flex items-center justify-between rounded-xl border border-slate-100 px-3 py-2 text-sm">
                    <div>
                      <p class="font-semibold text-slate-900">{{ file.name }}</p>
                      <p class="text-xs text-slate-500">{{ formatFileSize(file.size) }}</p>
                    </div>
                    <button
                      type="button"
                      class="text-xs font-semibold text-rose-600 hover:text-rose-500"
                      (click)="removeInternalAttachment(i)"
                    >
                      Remove
                    </button>
                  </div>
                }
              </div>
            }

            @if (cameraForm().existingInternalAttachments.length > 0) {
              <div class="space-y-2 rounded-2xl border border-slate-200 bg-white p-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Existing attachments</p>
                @for (attachment of cameraForm().existingInternalAttachments; track attachment._id) {
                  <div class="flex items-center justify-between rounded-xl border border-slate-100 px-3 py-2">
                    <a
                      class="flex flex-1 items-center justify-between text-sm text-indigo-600 hover:text-indigo-500"
                      [href]="getAttachmentUrl(attachment)"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      <span class="font-semibold text-slate-900">{{ attachment.originalName || attachment.name }}</span>
                      <span class="text-xs text-slate-500">{{ formatFileSize(attachment.size) }}</span>
                    </a>
                    <button
                      type="button"
                      class="ml-3 text-xs font-semibold text-rose-600 hover:text-rose-500"
                      (click)="deleteInternalAttachment(attachment._id)"
                      [disabled]="cameraForm().isSaving"
                      title="Delete attachment"
                    >
                      <svg viewBox="0 0 20 20" class="h-4 w-4 fill-current">
                        <path
                          fill-rule="evenodd"
                          d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>

        @if (cameraForm().error) {
          <div class="rounded-2xl bg-rose-50 p-4 text-sm text-rose-700 ring-1 ring-rose-200">
            {{ cameraForm().error }}
          </div>
        }

        <div class="flex items-center justify-end gap-4">
          <button
            type="button"
            class="rounded-2xl border border-slate-200 px-6 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50"
            (click)="cancel()"
            [disabled]="cameraForm().isSaving"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="rounded-2xl bg-indigo-600 px-6 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-200 transition hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
            [disabled]="cameraForm().isSaving"
          >
            @if (cameraForm().isSaving) {
              <span class="inline-flex items-center gap-2">
                <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
                Saving...
              </span>
            } @else {
              {{ isEditMode() ? 'Update Camera' : 'Add Camera' }}
            }
          </button>
        </div>
      </form>
    </div>
  }
</section>

