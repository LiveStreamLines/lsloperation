<div class="space-y-8">
  @if (toast()) {
    <div
      class="flex items-center justify-between rounded-2xl border px-4 py-3 text-sm shadow"
      [ngClass]="toast()!.tone === 'success' ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-rose-200 bg-rose-50 text-rose-700'"
    >
      <span>{{ toast()!.message }}</span>
      <button
        type="button"
        class="inline-flex items-center rounded-full border border-transparent bg-white/40 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:bg-white"
        (click)="dismissToast()"
      >
        Dismiss
      </button>
    </div>
  }

  <div class="flex flex-wrap items-center justify-between gap-4">
    <a
      routerLink="/camera-monitor"
      class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900"
    >
      <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M7.707 14.707a1 1 0 010-1.414L10.586 10 7.707 7.121a1 1 0 011.414-1.414l3.5 3.5a1 1 0 010 1.414l-3.5 3.5a1 1 0 01-1.414 0z"
          clip-rule="evenodd"
        />
      </svg>
      Back to monitor
    </a>

    @if (!isLoading() && hasHistory()) {
      <div class="flex flex-col text-right text-sm text-slate-500">
        <span class="font-semibold text-slate-900">{{ camera()?.camera || 'Unknown camera' }}</span>
        <span>{{ project()?.projectName || 'Unknown project' }} • {{ developer()?.developerName || 'Unknown developer' }}</span>
      </div>
    }
  </div>

  @if (isLoading()) {
    <div class="rounded-3xl border border-slate-200 bg-white p-12 text-center text-sm text-slate-500 shadow-sm">
      Loading camera history…
    </div>
  } @else {
    @if (errorMessage()) {
      <div class="rounded-3xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 shadow-sm">
        {{ errorMessage() }}
      </div>
    } @else {
      <div class="grid gap-6 xl:grid-cols-3">
        <section class="space-y-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm xl:col-span-1">
          <h2 class="text-lg font-semibold text-slate-900">Camera details</h2>
          <dl class="space-y-3 text-sm text-slate-600">
            <div>
              <dt class="font-semibold text-slate-800">Camera</dt>
              <dd>{{ camera()?.camera || 'Unknown camera' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Developer</dt>
              <dd>{{ developer()?.developerName || 'Unknown developer' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Project</dt>
              <dd>{{ project()?.projectName || 'Unknown project' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Country</dt>
              <dd>{{ camera()?.country || 'Not specified' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Server folder</dt>
              <dd>{{ camera()?.serverFolder || 'Not specified' }}</dd>
            </div>
          </dl>
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Assigned inventory</h3>
          </header>
          @if (cameraInventory().length === 0) {
            <p class="text-sm text-slate-500">No devices currently linked to this camera.</p>
          } @else {
            <ul class="grid gap-3 md:grid-cols-2 xl:grid-cols-3">
              @for (item of cameraInventory(); track item._id) {
                <li class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3">
                  <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide">
                    <span class="inline-flex items-center rounded-full border border-sky-300 bg-sky-100 px-3 py-1 text-sky-700">
                      {{ inventoryDeviceType(item) }}
                    </span>
                    @if (inventoryDeviceModel(item)) {
                      <span class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 text-slate-700">
                        {{ inventoryDeviceModel(item) }}
                      </span>
                    }
                    <span class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 text-slate-700">
                      {{ inventoryDeviceSerial(item) }}
                    </span>
                  </div>

                  @if (item.currentUserAssignment?.userName) {
                    <p class="text-xs text-slate-500">With {{ item.currentUserAssignment?.userName }}</p>
                  }
                  @if (item.currentAssignment?.assignedDate) {
                    <p class="text-xs text-slate-500">
                      Since {{ item.currentAssignment?.assignedDate | date: 'mediumDate' }}
                    </p>
                  }
                  @if (item.currentAssignment?.notes) {
                    <p class="text-xs text-slate-500">Notes: {{ item.currentAssignment?.notes }}</p>
                  }
                </li>
              }
            </ul>
          }
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Maintenance history</h3>
            <p class="text-xs text-slate-500">Tasks recorded for this camera.</p>
          </header>

          @if (sortedMaintenanceTasks().length === 0) {
            <p class="text-sm text-slate-500">No maintenance tasks found for this camera.</p>
          } @else {
            <div class="space-y-4">
              @for (task of sortedMaintenanceTasks(); track task._id) {
                <article class="rounded-2xl border border-slate-200 bg-slate-50/70 p-4 shadow-sm">
                  <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                      <p class="text-sm font-semibold text-slate-800">{{ task.taskType || 'Maintenance task' }}</p>
                      <p class="text-xs text-slate-500">{{ formatMaintenanceTimestamp(task) }}</p>
                    </div>
                    <span
                      class="inline-flex items-center rounded-full px-3 py-1 text-[11px] font-semibold uppercase tracking-wide"
                      [ngClass]="maintenanceStatusTone(task.status)"
                    >
                      {{ task.status | titlecase }}
                    </span>
                  </div>

                  @if (task.taskDescription) {
                    <p class="mt-3 text-sm text-slate-600">{{ task.taskDescription }}</p>
                  }

                  <div class="mt-3 flex flex-wrap gap-2 text-xs text-slate-500">
                    @if (formatAssignedUsers(task)) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Assigned: {{ formatAssignedUsers(task) }}
                      </span>
                    }

                    @if (task.userComment) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Comment: {{ task.userComment }}
                      </span>
                    }

                    @if (task.startTime) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Started: {{ task.startTime | date: 'medium' }}
                      </span>
                    }

                    @if (task.completionTime) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Completed: {{ task.completionTime | date: 'medium' }}
                      </span>
                    }
                  </div>

                  @if (task.dateOfRequest) {
                    <p class="mt-2 text-xs text-slate-500">Requested: {{ task.dateOfRequest | date: 'medium' }}</p>
                  }
                </article>
              }
            </div>
          }
        </section>
      </div>

      @if (hasHistory()) {
        <section class="grid gap-6 lg:grid-cols-2">
          <div class="space-y-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">First capture</h3>
            @if (firstPhotoUrl()) {
              <img [src]="firstPhotoUrl()" alt="First photo" class="w-full rounded-2xl border border-slate-100 object-cover shadow" />
              <p class="text-xs text-slate-500">{{ history()?.firstPhoto }}</p>
            } @else {
              <p class="text-sm text-slate-500">No photo available.</p>
            }
          </div>

          <div class="space-y-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Latest capture</h3>
            @if (lastPhotoUrl()) {
              <img [src]="lastPhotoUrl()" alt="Last photo" class="w-full rounded-2xl border border-slate-100 object-cover shadow" />
              <p class="text-xs text-slate-500">{{ history()?.lastPhoto }}</p>
            } @else {
              <p class="text-sm text-slate-500">No photo available.</p>
            }
          </div>
        </section>

        <section class="grid gap-6 lg:grid-cols-2">
          <div class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">
              Photos around {{ appliedDate1() || 'the first captured date' }}
            </h3>
            @if (history()?.date1Photos?.length) {
              <div class="grid gap-3 sm:grid-cols-2">
                @for (photo of history()?.date1Photos!; track photo) {
                  @if (buildHistoryImageUrl(photo)) {
                    <img
                      [src]="buildHistoryImageUrl(photo)!"
                      [alt]="'Photo ' + photo"
                      class="w-full rounded-2xl border border-slate-100 object-cover shadow"
                    />
                  }
                }
              </div>
            } @else {
              <p class="text-sm text-slate-500">No images captured on this day.</p>
            }
          </div>

          <div class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">
              Photos around {{ appliedDate2() || 'the latest captured date' }}
            </h3>
            @if (history()?.date2Photos?.length) {
              <div class="grid gap-3 sm:grid-cols-2">
                @for (photo of history()?.date2Photos!; track photo) {
                  @if (buildHistoryImageUrl(photo)) {
                    <img
                      [src]="buildHistoryImageUrl(photo)!"
                      [alt]="'Photo ' + photo"
                      class="w-full rounded-2xl border border-slate-100 object-cover shadow"
                    />
                  }
                }
              </div>
            } @else {
              <p class="text-sm text-slate-500">No images captured on this day.</p>
            }
          </div>
        </section>
      }

      <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
        <header class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold text-slate-900">History filters</h2>
            <p class="text-sm text-slate-500">Select a date range to preview images captured around noon.</p>
          </div>
          <div class="flex items-center gap-2 text-xs text-slate-500">
            <span>First capture: {{ appliedDate1() || '—' }}</span>
            <span class="h-1 w-1 rounded-full bg-slate-300"></span>
            <span>Latest capture: {{ appliedDate2() || '—' }}</span>
          </div>
        </header>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">Start date</span>
            <input
              type="date"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [value]="dateStart()"
              (change)="dateStart.set($any($event.target).value)"
            />
          </label>
          <label class="flex flex-col gap-2 text-sm text-slate-600">
            <span class="font-semibold text-slate-800">End date</span>
            <input
              type="date"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              [value]="dateEnd()"
              (change)="dateEnd.set($any($event.target).value)"
            />
          </label>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <button
            type="button"
            class="inline-flex items-center rounded-2xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-300 transition hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
            (click)="loadHistoryForDates()"
            [disabled]="isFetchingHistory()"
          >
            <span>Load history</span>
            @if (isFetchingHistory()) {
              <span class="ml-2 h-3 w-3 animate-spin rounded-full border border-white border-t-transparent"></span>
            }
          </button>
          <button
            type="button"
            class="inline-flex items-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900"
            (click)="generateWeeklyVideo()"
            [disabled]="isGeneratingVideo()"
          >
            <span>Generate weekly video</span>
            @if (isGeneratingVideo()) {
              <span class="ml-2 h-3 w-3 animate-spin rounded-full border border-slate-400 border-t-transparent"></span>
            }
          </button>
        </div>
      </section>

      @if (hasHistory()) {
        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Weekly noon snapshots</h3>
              <p class="text-xs text-slate-500">Captured automatically around 12:00 every week.</p>
            </div>
          </header>
          <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
            @for (photo of preview()?.weeklyImages!; track photo) {
              @if (buildPreviewImageUrl(photo)) {
                <img
                  [src]="buildPreviewImageUrl(photo)!"
                  [alt]="'Weekly photo ' + photo"
                  class="w-full rounded-2xl border border-slate-100 object-cover shadow"
                />
              }
            }
          </div>
        </section>
      }
    }
  }
</div>
