<div class="space-y-8">
  @if (toast()) {
    <div
      class="flex items-center justify-between rounded-2xl border px-4 py-3 text-sm shadow"
      [ngClass]="toast()!.tone === 'success' ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-rose-200 bg-rose-50 text-rose-700'"
    >
      <span>{{ toast()!.message }}</span>
      <button
        type="button"
        class="inline-flex items-center rounded-full border border-transparent bg-white/40 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:bg-white"
        (click)="dismissToast()"
      >
        Dismiss
      </button>
    </div>
  }

  @if (!cameraIdInput()) {
    <div class="flex flex-wrap items-center justify-between gap-4">
      <a
        routerLink="/camera-monitor"
        class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900"
      >
        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M7.707 14.707a1 1 0 010-1.414L10.586 10 7.707 7.121a1 1 0 011.414-1.414l3.5 3.5a1 1 0 010 1.414l-3.5 3.5a1 1 0 01-1.414 0z"
            clip-rule="evenodd"
          />
        </svg>
        Back to monitor
      </a>

      @if (!isLoading() && hasHistory()) {
        <div class="flex flex-col text-right text-sm text-slate-500">
          <span class="font-semibold text-slate-900">{{ camera()?.camera || 'Unknown camera' }}</span>
          <span>{{ project()?.projectName || 'Unknown project' }} • {{ developer()?.developerName || 'Unknown developer' }}</span>
        </div>
      }
    </div>
  }

  @if (isLoading()) {
    <div class="rounded-3xl border border-slate-200 bg-white p-12 text-center text-sm text-slate-500 shadow-sm">
      Loading camera history…
    </div>
  } @else {
    @if (errorMessage()) {
      <div class="rounded-3xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 shadow-sm">
        {{ errorMessage() }}
      </div>
    } @else {
      <div class="grid gap-6 xl:grid-cols-3">
        <section class="space-y-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm xl:col-span-1">
          <h2 class="text-lg font-semibold text-slate-900">Camera details</h2>
          <dl class="space-y-3 text-sm text-slate-600">
            <div>
              <dt class="font-semibold text-slate-800">Camera</dt>
              <dd>{{ camera()?.camera || 'Unknown camera' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Camera ID</dt>
              <dd class="font-mono text-xs text-slate-700">
                {{ camera()?._id || cameraIdInput() || 'Unknown ID' }}
              </dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Developer</dt>
              <dd>{{ developer()?.developerName || 'Unknown developer' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Project</dt>
              <dd>{{ project()?.projectName || 'Unknown project' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Country</dt>
              <dd>{{ camera()?.country || 'Not specified' }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-800">Server folder</dt>
              <dd>{{ camera()?.serverFolder || 'Not specified' }}</dd>
            </div>
          </dl>

          @if (health()) {
            @if (!health()!.error) {
              <div class="mt-6 space-y-3 rounded-2xl border border-indigo-200 bg-indigo-50 p-4">
                <h3 class="text-sm font-semibold text-indigo-900">Camera Health</h3>
                <dl class="space-y-2 text-sm text-indigo-700">
                  @if (health()!.firstDay) {
                    <div class="flex items-center justify-between">
                      <dt class="font-semibold text-indigo-800">{{ health()!.firstDay?.date }} (Yesterday)</dt>
                      <dd class="font-semibold text-indigo-900">{{ health()!.firstDay?.count }} images</dd>
                    </div>
                  } @else {
                    <div class="flex items-center justify-between">
                      <dt class="font-semibold text-indigo-800">Yesterday</dt>
                      <dd class="font-semibold text-indigo-900">0 images</dd>
                    </div>
                  }
                </dl>
              </div>
            } @else {
              <div class="mt-6 space-y-3 rounded-2xl border border-amber-200 bg-amber-50 p-4">
                <h3 class="text-sm font-semibold text-amber-900">Camera Health</h3>
                <p class="text-sm text-amber-700">{{ health()!.error || 'Health data unavailable' }}</p>
              </div>
            }
          }
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Assigned inventory</h3>
          </header>
          @if (cameraInventory().length === 0) {
            <p class="text-sm text-slate-500">No devices currently linked to this camera.</p>
          } @else {
            <ul class="grid gap-3 md:grid-cols-2 xl:grid-cols-3">
              @for (item of cameraInventory(); track item._id) {
                <li class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3">
                  <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide">
                    <span class="inline-flex items-center rounded-full border border-sky-300 bg-sky-100 px-3 py-1 text-sky-700">
                      {{ inventoryDeviceType(item) }}
                    </span>
                    @if (inventoryDeviceModel(item)) {
                      <span class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 text-slate-700">
                        {{ inventoryDeviceModel(item) }}
                      </span>
                    }
                    <span class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 text-slate-700">
                      {{ inventoryDeviceSerial(item) }}
                    </span>
                  </div>

                  @if (item.currentUserAssignment?.userName) {
                    <p class="text-xs text-slate-500">With {{ item.currentUserAssignment?.userName }}</p>
                  }
                  @if (item.currentAssignment?.assignedDate) {
                    <p class="text-xs text-slate-500">
                      Since {{ item.currentAssignment?.assignedDate | date: 'mediumDate' }}
                    </p>
                  }
                  @if (item.currentAssignment?.notes) {
                    <p class="text-xs text-slate-500">Notes: {{ item.currentAssignment?.notes }}</p>
                  }
                </li>
              }
            </ul>
          }
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Memory information</h3>
          </header>

          @if (cameraMemories().length === 0) {
            <p class="text-sm text-slate-500">No memory records found for this camera.</p>
          } @else {
            <ul class="space-y-3">
              @for (memory of cameraMemories(); track memory._id) {
                <li class="space-y-2 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <span class="font-semibold text-slate-800">
                      Status:
                      {{ (memory.status || 'active') | titlecase }}
                    </span>
                    <span class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-700">
                      Memory
                    </span>
                  </div>

                  <div class="grid gap-2 md:grid-cols-2">
                    <div>
                      <p>Used: <span class="font-semibold">{{ memory.memoryUsed || '—' }}</span></p>
                      <p>Available: <span class="font-semibold">{{ memory.memoryAvailable || '—' }}</span></p>
                    </div>
                    <div>
                      <p>
                        Pictures:
                        <span class="font-semibold">
                          {{ memory.numberofpics ?? memory['numberOfPics'] ?? memory['numberofpic'] ?? memory['numberOfPic'] ?? '—' }}
                        </span>
                      </p>
                      <p>Shutter count: <span class="font-semibold">{{ memory.shuttercount ?? '—' }}</span></p>
                    </div>
                  </div>

                  <div class="grid gap-1 md:grid-cols-2 text-[11px] text-slate-500">
                    <p>
                      Start:
                      <span class="font-semibold">
                        {{ memory.createdDate ? (memory.createdDate | date: 'medium') : '—' }}
                      </span>
                    </p>
                    <p>
                      End:
                      <span class="font-semibold">
                        {{
                          memory.endDate
                            ? (memory.endDate | date: 'medium')
                            : memory.dateOfRemoval
                              ? (memory.dateOfRemoval | date: 'medium')
                              : memory.dateOfReceive
                                ? (memory.dateOfReceive | date: 'medium')
                                : '—'
                        }}
                      </span>
                    </p>
                  </div>
                </li>
              }
            </ul>
          }
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Maintenance history</h3>
            <p class="text-xs text-slate-500">Tasks recorded for this camera.</p>
          </header>

          @if (sortedMaintenanceTasks().length === 0) {
            <p class="text-sm text-slate-500">No maintenance tasks found for this camera.</p>
          } @else {
            <div class="space-y-4">
              @for (task of sortedMaintenanceTasks(); track task._id) {
                <article class="rounded-2xl border border-slate-200 bg-slate-50/70 p-4 shadow-sm">
                  <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                      <p class="text-sm font-semibold text-slate-800">{{ task.taskType || 'Maintenance task' }}</p>
                      <p class="text-xs text-slate-500">{{ formatMaintenanceTimestamp(task) }}</p>
                    </div>
                    <span
                      class="inline-flex items-center rounded-full px-3 py-1 text-[11px] font-semibold uppercase tracking-wide"
                      [ngClass]="maintenanceStatusTone(task.status)"
                    >
                      {{ task.status | titlecase }}
                    </span>
                  </div>

                  @if (task.taskDescription) {
                    <p class="mt-3 text-sm text-slate-600">{{ task.taskDescription }}</p>
                  }

                  <div class="mt-3 flex flex-wrap gap-2 text-xs text-slate-500">
                    @if (formatAssignedUsers(task)) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Assigned: {{ formatAssignedUsers(task) }}
                      </span>
                    }

                    @if (task.userComment) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Comment: {{ task.userComment }}
                      </span>
                    }

                    @if (task.startTime) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Started: {{ task.startTime | date: 'medium' }}
                      </span>
                    }

                    @if (task.completionTime) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Completed: {{ task.completionTime | date: 'medium' }}
                      </span>
                    }
                  </div>

                  @if (task.dateOfRequest) {
                    <p class="mt-2 text-xs text-slate-500">Requested: {{ task.dateOfRequest | date: 'medium' }}</p>
                  }
                </article>
              }
            </div>
          }
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Status history</h3>
            <p class="text-xs text-slate-500">History of photo dirty, better view, less image, wrong time, shutter expiry, and device expiry status changes.</p>
          </header>

          @if (!hasStatusHistory()) {
            <p class="text-sm text-slate-500">No status history found for this camera.</p>
          } @else {
            <div class="space-y-3">
              @for (entry of sortedStatusHistory(); track entry._id) {
                <article class="rounded-2xl border border-slate-200 bg-slate-50/70 p-4 shadow-sm">
                  <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex-1">
                      <div class="flex flex-wrap items-center gap-2">
                        <span
                          class="inline-flex items-center rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide"
                          [ngClass]="getStatusActionColor(entry.action)"
                        >
                          {{ getStatusActionLabel(entry.action) }}
                        </span>
                        <span class="text-sm font-semibold text-slate-800">
                          {{ getStatusTypeLabel(entry.statusType) }}
                        </span>
                      </div>
                      <p class="mt-1 text-xs text-slate-500">
                        {{ entry.performedAt | date: 'medium' }}
                      </p>
                    </div>
                  </div>

                  <div class="mt-3 flex flex-wrap gap-2 text-xs text-slate-500">
                    <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                      By: {{ entry.performedBy }}
                    </span>
                    @if (entry.performedByEmail) {
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold uppercase tracking-wide text-slate-600">
                        Email: {{ entry.performedByEmail }}
                      </span>
                    }
                  </div>
                </article>
              }
            </div>
          }
        </section>
      </div>

      @if (hasHistory()) {
        <section class="grid gap-6 lg:grid-cols-2">
          <div class="space-y-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">First capture</h3>
            @if (firstPhotoUrl()) {
              <img 
                [src]="firstPhotoUrl()" 
                alt="First photo" 
                class="max-w-xs mx-auto w-full rounded-2xl border border-slate-100 object-cover shadow cursor-pointer transition hover:opacity-80"
                (click)="openImageModal(firstPhotoUrl())"
              />
              <p class="text-xs text-slate-500 text-center">{{ formatPhotoDate(history()?.firstPhoto) }}</p>
            } @else {
              <p class="text-sm text-slate-500">No photo available.</p>
            }
          </div>

          <div class="space-y-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Latest capture</h3>
            @if (lastPhotoUrl()) {
              <img 
                [src]="lastPhotoUrl()" 
                alt="Last photo" 
                class="max-w-xs mx-auto w-full rounded-2xl border border-slate-100 object-cover shadow cursor-pointer transition hover:opacity-80"
                (click)="openImageModal(lastPhotoUrl())"
              />
              <p class="text-xs text-slate-500 text-center">{{ formatPhotoDate(history()?.lastPhoto) }}</p>
            } @else {
              <p class="text-sm text-slate-500">No photo available.</p>
            }
          </div>
        </section>

        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <h2 class="text-lg font-semibold text-slate-900">Select Date</h2>
              <p class="text-sm text-slate-500">Choose a date to view all images captured on that day.</p>
            </div>
          </header>

          <div class="flex gap-4 items-end">
            <label class="flex flex-col gap-2 text-sm text-slate-600 flex-1 max-w-xs">
              <span class="font-semibold text-slate-800">Date</span>
              <input
                type="date"
                class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                [value]="selectedDate()"
                (change)="onDateChange($any($event.target).value)"
              />
            </label>
            @if (isFetchingHistory()) {
              <div class="flex items-center gap-2 text-sm text-slate-500">
                <span class="h-4 w-4 animate-spin rounded-full border border-slate-300 border-t-indigo-500"></span>
                <span>Loading...</span>
              </div>
            }
          </div>
        </section>

        @if (appliedDate()) {
          <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">
              Photos on {{ appliedDate() }}
            </h3>
            @if (dailyPhotos().length) {
              <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
                @for (photo of dailyPhotos(); track photo) {
                  @if (buildHistoryImageUrl(photo)) {
                    <div class="space-y-1">
                      <div class="relative group">
                        <img
                          [src]="buildHistoryImageUrl(photo)!"
                          [alt]="'Photo ' + photo"
                          class="w-full rounded-2xl border border-slate-100 object-cover shadow cursor-pointer transition hover:opacity-80"
                          (click)="openImageModal(buildHistoryImageUrl(photo)!)"
                        />
                        @if (canDeletePhoto()) {
                          <button
                            type="button"
                            class="absolute top-2 right-2 hidden group-hover:inline-flex items-center rounded-full bg-rose-600/90 px-2.5 py-1 text-xs font-semibold uppercase tracking-wide text-white shadow-md hover:bg-rose-700"
                            (click)="onDeletePhoto(photo); $event.stopPropagation()"
                          >
                            Delete
                          </button>
                        }
                      </div>
                      <p class="text-[11px] text-slate-500 text-center">
                        {{ formatPhotoDate(photo) }}
                      </p>
                    </div>
                  }
                }
              </div>
            } @else {
              <p class="text-sm text-slate-500">No images captured on this day.</p>
            }
          </section>
        }
      }

      @if (hasHistory()) {
        <section class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Weekly noon snapshots</h3>
              <p class="text-xs text-slate-500">Captured automatically around 12:00 every week.</p>
            </div>
          </header>
          <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
            @for (photo of preview()?.weeklyImages!; track photo) {
              @if (buildPreviewImageUrl(photo)) {
                <div class="space-y-2">
                  <img
                    [src]="buildPreviewImageUrl(photo)!"
                    [alt]="'Weekly photo ' + photo"
                    class="w-full rounded-2xl border border-slate-100 object-cover shadow cursor-pointer transition hover:opacity-80"
                    (click)="openImageModal(buildPreviewImageUrl(photo)!)"
                  />
                  <p class="text-xs font-semibold text-slate-600 text-center">{{ formatWeeklyImageDate(photo) }}</p>
                </div>
              }
            }
          </div>
        </section>
      }
    }
  }

  @if (selectedImageUrl()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm" (click)="closeImageModal()">
      <div class="relative max-w-7xl max-h-[90vh] p-4" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="absolute right-0 top-0 z-10 rounded-full border border-slate-200 bg-white p-2 text-slate-500 transition hover:text-slate-900 shadow-md"
          (click)="closeImageModal()"
        >
          <span class="sr-only">Close modal</span>
          <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path
              d="M6.28 5.22a.75.75 0 10-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 10-1.06-1.06L10 8.94 6.28 5.22z"
            />
          </svg>
        </button>
        <img
          [src]="getLargeImageUrl(selectedImageUrl())!"
          alt="Large image"
          class="max-w-full max-h-[90vh] w-auto h-auto rounded-2xl shadow-2xl object-contain"
        />
      </div>
    </div>
  }
</div>
